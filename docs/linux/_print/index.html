<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.115.2">
<link rel="canonical" type="text/html" href="https://bwangel.me/647/docs/linux/">
<link rel="alternate" type="application/rss&#43;xml" href="https://bwangel.me/647/docs/linux/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/647/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/647/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/647/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/647/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/647/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/647/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/647/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/647/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/647/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/647/favicons/android-192x192.png" sizes="192x192">

<title>Linux | 647 Universe</title>
<meta name="description" content="宇宙很大，生活更大，也许以后还有缘相见">
<meta property="og:title" content="Linux" />
<meta property="og:description" content="宇宙很大，生活更大，也许以后还有缘相见" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://bwangel.me/647/docs/linux/" /><meta property="og:site_name" content="647号宇宙" />
<meta itemprop="name" content="Linux">
<meta itemprop="description" content="宇宙很大，生活更大，也许以后还有缘相见"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linux"/>
<meta name="twitter:description" content="宇宙很大，生活更大，也许以后还有缘相见"/>




<link rel="preload" href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" as="style">
<link href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/647/css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/647/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">647 Universe</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/647/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/647/docs/linux/"></a>.
</p>
</div>



<h1 class="title">Linux</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-1c2b211e34ea807b66d53c40bac236f2">curl</a></li>


    
  
    
    
	
<li>2: <a href="#pg-a5f545a950366d730141f62b977f5c24">lsof</a></li>


    
  
    
    
	
<li>3: <a href="#pg-69dc1da95bd41a25bf26e181c6ed42e5">DNS</a></li>


    
  
    
    
	
<li>4: <a href="#pg-634110a9992b6264c18b7b4beda6f789">在 Ubuntu 22.04 上搭建 NFS Server</a></li>


    
  
    
    
	
<li>5: <a href="#pg-dd6083187c74288b0bc340d1a5d75a6f">ls Tips</a></li>


    
  
    
    
	
<li>6: <a href="#pg-d666840fe7c4f359e7566250aad67c80">查看信号的快捷键</a></li>


    
  
    
    
	
<li>7: <a href="#pg-549a76c189e9345d4226a12a7a7595fd">Review 《File Descriptor Transfer over Unix Domain Sockets》</a></li>


    
  
    
    
	
<li>8: <a href="#pg-50e13d0c712358d46277160b2eed624c">Glob 语法解析</a></li>


    
  
    
    
	
<li>9: <a href="#pg-efaf8b11c2c533130e7721f968b66120">词法分析器生成工具 Lex 简介</a></li>


    
  
    
    
	
<li>10: <a href="#pg-25c9fa87749c3a8b80df79ec7693c21d">【流水账】利用闲置笔记本搭建自己的开发服务器</a></li>


    
  
    
    
	
<li>11: <a href="#pg-3b4ec5fedefcf82985dda74fa4bef98c">【非技术】 Arch 下的无线自动断开</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1c2b211e34ea807b66d53c40bac236f2">1 - curl</h1>
    
	<h2 id="curl-post-json-数据">curl POST JSON 数据</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -X PUT -H <span style="color:#4e9a06">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#4e9a06">&#39;@/tmp/demo.json&#39;</span> :9200/demo
</span></span><span style="display:flex;"><span>ø&gt; cat /tmp/demo.json
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;settings&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;number_of_shards&#34;</span>: 1,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;number_of_replicas&#34;</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="使用---resolve-选项替换域名">使用 <code>--resolve</code> 选项替换域名</h2>
<ul>
<li>将 <a href="https://www.google.com">www.google.com</a> 替换成 127.0.0.1，并访问 8000 端口</li>
</ul>
<p><code>curl -v --resolve www.google.com:8000:127.0.0.1 http://www.google.com:8000/ping</code></p>
<ul>
<li>将 <a href="https://www.google.com">https://www.google.com</a> 替换成 127.0.0.1，此时 curl 会忽略证书和域名不匹配的问题</li>
</ul>
<p><code>curl -v --resolve www.google.com:443:127.0.0.1 https://www.google.com/ping</code></p>
<ul>
<li>将 <a href="http://www.google.com">http://www.google.com</a> 替换成 127.0.0.1，http 默认访问 80 端口</li>
</ul>
<p><code>curl -v --resolve www.google.com:80:127.0.0.1 http://www.google.com/ping</code></p>
<h2 id="--fail-和---fail-with-body"><code>--fail</code> 和 <code>--fail-with-body</code></h2>
<p>这两个选项都可以让 curl 在接收到 400 及以上的 HTTP 响应码的时候，将退出码设置为 22</p>
<p><code>--fail-with-body</code> 会输出服务端返回的内容到 stdout 或文件中</p>
<p><code>--fail</code> 不会有任何输出，当服务端返回的是认证相关的状态码时(401/407), 可能会让使用者误以为出错了</p>
<h3 id="使用场景">使用场景</h3>
<p>在一个 dockerfile 中，我期望下载项目的 <code>go.mod</code> 和 <code>go.sum</code> 文件，然后再执行 <code>go mod download</code>。
这样可以在 clone 代码之前，先下载 go module 文件。</p>
<p>如果项目的代码变了，但是依赖并没有变，因为 docker build 的缓存原理，可以省去下载 go module 的步骤。</p>
<pre tabindex="0"><code>...
ARG app_repo
ARG app_commit

RUN [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum

RUN cd /tmp/app &amp;&amp; go mod download
...
</code></pre><p>当 app_repo 和 app_commit 参数错误，导致对应的 go.mod 文件不存在，curl 会得到 404 的 HTTP 响应码，此时我期望 docker build 出错。</p>
<p>但实际上并不会出错，docker build 会继续执行，直到 go mod download 文件无法识别 go.mod 文件，docker build 才会异常退出。</p>
<p>显示的错误内容如下:</p>
<pre tabindex="0"><code>0.467 go: errors parsing go.mod:
0.467 /tmp/app/go.mod:1: unknown directive: 404:
</code></pre><p>当我给 <code>curl</code> 加上了 <code>--fail</code> 选项之后，程序就会在下载 go.mod 出错时直接退出。显示的错误如下:</p>
<pre tabindex="0"><code>ERROR: failed to solve: 
	process &#34;
		/bin/bash -c [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp;
		curl --fail -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp;
		curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum
	&#34; did not complete successfully: exit code: 22
</code></pre><p>最终的 dockerfile 代码及复现命令</p>
<pre tabindex="0"><code>FROM golang:1.19
SHELL [&#34;/bin/bash&#34;, &#34;-c&#34;]

ARG app_repo
ARG app_commit

RUN go env -w GOPROXY=https://goproxy.cn,direct

RUN [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp; \
    curl --fail -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum

RUN cd /tmp/app &amp;&amp; go mod download
RUN HTTP_PROXY=&#39;http://改成你自己的代理&#39; HTTPS_PROXY=&#39;http://改成你自己的代理&#39; git clone https://github.com/${app_repo}.git ~/app
RUN cd ~/app &amp;&amp; git reset --hard ${app_commit} &amp;&amp; go build .
</code></pre><ul>
<li>复现命令</li>
</ul>
<pre tabindex="0"><code># 注意这个 app_commit 是一个不存在的 commit
docker build -t curl_test --build-arg app_repo=bwangelme/rdcdemo --build-arg app_commit=2f24a0658d7feb0205e7d75b7ae218ff6495e8f3 .
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a5f545a950366d730141f62b977f5c24">2 - lsof</h1>
    
	<h2 id="按照网络状态筛选进程的-fd">按照网络状态筛选进程的 fd</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sTCP:LISTEN -a -p &lt;pid&gt;
</span></span></code></pre></div><ul>
<li>
<p><code>-a</code> 表示 and, 前后两个条件要一起生效</p>
</li>
<li>
<p><code>-i</code> 和 <code>-s</code> 一起用，表示可以按照 TCP/UDP 状态来筛选 fd</p>
</li>
<li>
<p>列出进程 <code>&lt;pid&gt;</code> 建立的所有 TCP 连接</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sTCP:ESTABLISHED -a -p &lt;pid&gt;
</span></span></code></pre></div><ul>
<li>列出进程 <code>&lt;pid&gt;</code> 所有 IDLE 状态的 UDP 连接</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sUDP:IDLE -a -p &lt;pid&gt;
</span></span></code></pre></div><p>根据 Unix 发行版本的不同，TCP/UDP 状态也会有不同的名字:</p>
<ul>
<li>常用的 TCP 状态是: <code>CLOSED</code>, <code>IDLE</code>, <code>BOUND</code>, <code>LISTEN</code>, <code>ESTABLISHED</code>, <code>SYN_SENT</code>, <code>SYN_RCDV</code>, <code>ESTABLISHED</code>, <code>CLOSE_WAIT</code>, <code>FIN_WAIT1</code>, <code>CLOSING</code>, <code>LAST_ACK</code>, <code>FIN_WAIT_2</code>, <code>TIME_WAIT</code>.</li>
<li>常用的 UDP 状态是: <code>Unbound</code>, <code>Idle</code></li>
</ul>
<h2 id="按照-fd-number-查找进程的-fd">按照 fd number 查找进程的 fd</h2>
<p>使用 <code>strace</code> 查看进程的系统调用的时候，经常能够看到在某个 fd 上执行读写操作，例如:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>267, <span style="color:#4e9a06">&#34;\1\0\0\0\0\0\0\0&#34;</span>, 8<span style="color:#ce5c00;font-weight:bold">)</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>5405, <span style="color:#4e9a06">&#34;# Kubernetes-managed hosts file &#34;</span>..., 4096<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4096</span>
</span></span></code></pre></div><p>我们想要查一下这个 267 和 5405 具体代表了什么连接，可以用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -d &lt;fd_number&gt; -a -p &lt;pid&gt;
</span></span></code></pre></div><p>例如我利用 strace 查看飞书 app 的系统调用，看到以下的信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo strace -p <span style="color:#0000cf;font-weight:bold">8261</span>
</span></span><span style="display:flex;"><span>strace: Process <span style="color:#0000cf;font-weight:bold">8261</span> attached
</span></span><span style="display:flex;"><span>restart_syscall<span style="color:#ce5c00;font-weight:bold">(</span>&lt;... resuming interrupted <span style="color:#204a87">read</span> ...&gt;<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/proc/self/status&#34;</span>, O_RDONLY<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>4, <span style="color:#4e9a06">&#34;Name:\tfeishu\nUmask:\t0002\nState:\t&#34;</span>..., 1024<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1024</span>
</span></span><span style="display:flex;"><span>close<span style="color:#ce5c00;font-weight:bold">(</span>4<span style="color:#ce5c00;font-weight:bold">)</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffead8, FUTEX_WAKE_PRIVATE, 2147483647<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffea88, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>poll<span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>23, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>67, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}]</span>, 5, 0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">(</span>Timeout<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>poll<span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>23, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>67, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}]</span>, 5, 200<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">revents</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}])</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>10, <span style="color:#4e9a06">&#34;!&#34;</span>, 2<span style="color:#ce5c00;font-weight:bold">)</span>                        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffead8, FUTEX_WAKE_PRIVATE, 2147483647<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffea88, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a0001eb8, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/proc/self/status&#34;</span>, O_RDONLY<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>4, <span style="color:#4e9a06">&#34;Name:\tfeishu\nUmask:\t0002\nState:\t&#34;</span>..., 1024<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1024</span>
</span></span></code></pre></div><p>我想知道 fd 4 代表了什么，执行 <code>sudo lsof -d 4 -a -p 8261</code>，可以看到它是我的电脑和 <code>220.181.131.241</code> 建立的一个 https 连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo lsof -d <span style="color:#0000cf;font-weight:bold">4</span> -a -p <span style="color:#0000cf;font-weight:bold">8261</span>
</span></span><span style="display:flex;"><span>COMMAND  PID      USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>feishu  <span style="color:#0000cf;font-weight:bold">8261</span> xuyundong    4u  IPv4 <span style="color:#0000cf;font-weight:bold">2613086</span>      0t0  TCP 192.168.252.88:35810-&gt;220.181.131.241:https <span style="color:#ce5c00;font-weight:bold">(</span>ESTABLISHED<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="查看端口占用">查看端口占用</h2>
<p>有时候我们启动程序的时候，发现端口被占用了，可以用 <code>lsof -i:xxx</code> 来查看端口被哪个进程占用了，例如:</p>
<p>下面这条命令显示 3306 端口被 <code>360702</code> 和 <code>360709</code> 两个进程占用了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo lsof -i:3306
</span></span><span style="display:flex;"><span>COMMAND      PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>docker-pr <span style="color:#0000cf;font-weight:bold">360702</span> root    4u  IPv4 <span style="color:#0000cf;font-weight:bold">1842886</span>      0t0  TCP *:mysql <span style="color:#ce5c00;font-weight:bold">(</span>LISTEN<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>docker-pr <span style="color:#0000cf;font-weight:bold">360709</span> root    4u  IPv6 <span style="color:#0000cf;font-weight:bold">1842889</span>      0t0  TCP *:mysql <span style="color:#ce5c00;font-weight:bold">(</span>LISTEN<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="查看容器的网络调用">查看容器的网络调用</h2>
<h3 id="构建镜像">构建镜像</h3>
<ul>
<li>download.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -*- coding: utf-8 -*-&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">requests</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">resp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">requests</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;https://releases.ubuntu.com/22.04.2/ubuntu-22.04.2-desktop-amd64.iso?_ga=2.131295240.668169970.1684741981-917190618.1681460407&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status_code</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>Dockerfile</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> python:3.10</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> pip install requests<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> download.py /download.py<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ENTRYPOINT</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;python&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/download.py&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">
</span></span></span></code></pre></div><p>准备上述两个文件，然后执行</p>
<pre tabindex="0"><code>docker build -t test_download .
</code></pre><p>构建我们用于调试的镜像, <code>test_download</code> 。</p>
<h3 id="启动阻塞的容器">启动阻塞的容器</h3>
<p>执行以下命令，启动一个阻塞在网络请求中的容器。</p>
<pre tabindex="0"><code>docker run --rm test_download
</code></pre><blockquote>
<p><strong>Note</strong>:</p>
<p>这个例子不太好，因为 <code>releases.ubuntu.com</code> 还比较健康，会持续地返回内容，现实中我们遇到的情况是，服务器完全不返回内容，客户端也没有设置超时时间，完全处于阻塞的状态。</p>
</blockquote>
<h3 id="查找容器的-pid">查找容器的 pid</h3>
<p>根据容器的 ID, 我们通过 <code>docker inspect &lt;id&gt;| rg -i pid</code> 可以获得容器的进程 ID</p>
<p>如果你使用的是 containerd, 可以使用 <code>crictl inspect &lt;id&gt; | rg -i pid</code></p>
<pre tabindex="0"><code>ø&gt; docker ps
CONTAINER ID   IMAGE           COMMAND                 CREATED          STATUS          PORTS     NAMES
bf5846384913   test_download   &#34;python /download.py&#34;   37 seconds ago   Up 36 seconds             friendly_wozniak
ø&gt; docker inspect bf5846384913 | rg -i pid
            &#34;Pid&#34;: 726678,
            &#34;PidMode&#34;: &#34;&#34;,
            &#34;PidsLimit&#34;: null,
</code></pre><h3 id="利用-strace-查看进程的状态">利用 strace 查看进程的状态</h3>
<p>从 strace 的输出中可以看到，进程一直在从 3 号 fd 上读取数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# strace -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span><span style="display:flex;"><span>strace: Process <span style="color:#0000cf;font-weight:bold">726678</span> attached
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;Z\263\351\331\315\17\330\205\222\361\21\235&#39;Kp\301w\256\365|\275K\326y\350@\305\300\325\262\fk&#34;</span>..., 13131<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1448</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\317GKJ\324O)1\5\272\\\&#34;\24\360s\177\263\223#\376\360\35\360\226\240\214mf\374\243\222\335&#34;</span>..., 11683<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">11683</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\22c\367U@\243\377\325\255\n0\376\79J\244\v9O4\233Kq\0233\304k\6\356dy\20&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;[\244K\30\7\30?[\210\313\364\335\t\321&gt;l\270\2\365\262\307|\376\211.\376\342%\361\34\31\246&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\335\373\354\320:SF\244o#\244\377Ll\21\366AT\374vgYD\2418\305\340\313||\243;&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;X \300\240\252IoZ\352W</span>$<span style="color:#4e9a06">\255\266\324\304q\306\23\226-b\212\300\271\222pI\270\33\tcn&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\213\331\225\331b\2405\204\f\213\32\r\250;\250\326.\4l\221\230^0\272{\317\32he\262V\223&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>brk<span style="color:#ce5c00;font-weight:bold">(</span>0x55fba8f48000<span style="color:#ce5c00;font-weight:bold">)</span>                     <span style="color:#ce5c00;font-weight:bold">=</span> 0x55fba8f48000
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\4\317\362`-R}\360\&#34;\266nZ\33\261s,\340\345\371\300;]\347\30\237\344\305\235m\360j\357&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;1v\355\312]nG\347\240\4\210\350\241\34\257\333\307\233z\261\0\6\307\2234n\21V\27\305\272\371&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><h3 id="利用-lsof-查看-fd-详细信息">利用 lsof 查看 fd 详细信息</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nsenter -n -t <span style="color:#0000cf;font-weight:bold">726678</span> lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# nsenter -n -t <span style="color:#0000cf;font-weight:bold">726678</span> lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span><span style="display:flex;"><span>COMMAND    PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>python  <span style="color:#0000cf;font-weight:bold">726678</span> root    3u  IPv4 <span style="color:#0000cf;font-weight:bold">9813984</span>      0t0  TCP 172.17.0.2:55378-&gt;https-services.aerodent.canonical.com:https <span style="color:#ce5c00;font-weight:bold">(</span>ESTABLISHED<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>可以看到，3号fd 是一个TCP 连接，本地的 <code>172.17.0.2:55378</code> 连接了远端的 <code>https-services.aerodent.canonical.com:https</code></p>
<blockquote>
<p><strong>Note</strong></p>
<p>如果我们不加 nsenter -n -t <pid> 来切换 network namespace 的话，lsof 输出的信息中就没有详细的客户端和服务端的地址了</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">729160</span>
</span></span><span style="display:flex;"><span>COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF    NODE NAME
</span></span><span style="display:flex;"><span>python  <span style="color:#0000cf;font-weight:bold">729160</span> root    3u  sock    0,8      0t0 <span style="color:#0000cf;font-weight:bold">9829458</span> protocol: TCP
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://linux.die.net/man/8/lsof">man lsof</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-69dc1da95bd41a25bf26e181c6ed42e5">3 - DNS</h1>
    
	<h2 id="a-记录">A 记录</h2>
<p>Address Mapping records, 指示了对应名称的IPv4地址, A记录用来将域名转换为ip地址.</p>
<h2 id="aaaa-记录">AAAA 记录</h2>
<p>类似于A记录, 只不过指示的是IPv6的地址。</p>
<p>因为 IPv6 地址长度是 IPv4 的四倍，所以用 AAAA 表示 IPv6 记录</p>
<h2 id="ns-记录">NS 记录</h2>
<ul>
<li>Name Server records, 用来指定对应名称的可信名称服务器 (authoritative name server)</li>
</ul>
<p>例如这段 dig 日志是 <code>j.gtld-servers.net</code> 告诉我们，它不知道 <code>www.baidu.com</code> 的 IP, 但是它告诉我们要查询 <code>baidu.com.</code> 域的地址，可以去 ns[12345].baidu.com 这5个地址中查。</p>
<pre tabindex="0"><code>baidu.com.              172800  IN      NS      ns2.baidu.com.
baidu.com.              172800  IN      NS      ns3.baidu.com.
baidu.com.              172800  IN      NS      ns4.baidu.com.
baidu.com.              172800  IN      NS      ns1.baidu.com.
baidu.com.              172800  IN      NS      ns7.baidu.com.
;; Received 849 bytes from 192.48.79.30#53(j.gtld-servers.net) in 316 ms
</code></pre><h2 id="ptr-记录">PTR 记录</h2>
<p>Pointer records, 通过 IP 反查域名，大部分域名服务器都不支持，目前只找到了 <code>dns.google.</code> 支持 PTR 查询</p>
<pre tabindex="0"><code>ø&gt; dig -x 8.8.4.4

;; QUESTION SECTION:
;4.4.8.8.in-addr.arpa.          IN      PTR

;; ANSWER SECTION:
4.4.8.8.in-addr.arpa.   1       IN      PTR     dns.google.
</code></pre><h2 id="cname-记录">CNAME 记录</h2>
<p>又称 alias 别名，是 A 记录的别名</p>
<p>例如以下的查询说明</p>
<ol>
<li><code>www.baidu.com.</code> 是 <code>www.a.shifen.com.</code> 的别名</li>
<li><code>www.a.shifen.com.</code> 指向了 <code>220.181.38.150</code> 和 <code>220.181.38.149</code></li>
</ol>
<pre tabindex="0"><code>ø&gt; dig -4 www.baidu.com

;; QUESTION SECTION:
;www.baidu.com.                 IN      A

;; ANSWER SECTION:
www.baidu.com.          70      IN      CNAME   www.a.shifen.com.
www.a.shifen.com.       53      IN      A       220.181.38.150
www.a.shifen.com.       53      IN      A       220.181.38.149
</code></pre><h2 id="查询方式">查询方式</h2>
<h3 id="递归查询">递归查询</h3>
<p>client 发送请求给局域网 DNS, 局域网 DNS 再去上游 DNS 服务器执行进一步查询。一级一级向上递归并回到局域网 DNS , 局域网 DNS 将查询的地址返回给客户端</p>
<p>dig 命令默认执行的就是递归查询</p>
<h3 id="集中查询">集中查询</h3>
<ol>
<li>client 发送请求给局域网 DNS 获得 DNS 根服务器的地址</li>
<li>client 请求根服务器获得下一级 DNS 服务器地址</li>
<li>以此往复，一级一级直到查到目标域名的 IP 地址</li>
</ol>
<p>以下用集中查询的方式查询 <a href="https://www.baidu.com">www.baidu.com</a> IP 地址的过程</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; dig -4 +trace www.baidu.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取根服务器的名字列表</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> &lt;&lt;&gt;&gt; DiG 9.18.12-0ubuntu0.22.04.2-Ubuntu &lt;&lt;&gt;&gt; -4 +trace www.baidu.com
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> global options: +cmd
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      k.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      b.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      h.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      i.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      l.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      c.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      a.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      d.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      e.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      m.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      f.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      g.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      j.root-servers.net.
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">239</span> bytes from 10.8.0.1#53<span style="color:#ce5c00;font-weight:bold">(</span>10.8.0.1<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">4</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 根服务器返回通用定义域名的名字列表</span>
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      a.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      b.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      c.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      d.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      e.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      f.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      g.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      h.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      i.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      j.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      k.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      l.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      m.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">86400</span>   IN      DS      <span style="color:#0000cf;font-weight:bold">30909</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">2</span> E2D3C916F6DEEAC73294E8268FB5885044A833FC5459588F4A9184CF C41A5766
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">86400</span>   IN      RRSIG   DS <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">86400</span> <span style="color:#0000cf;font-weight:bold">20230921210000</span> <span style="color:#0000cf;font-weight:bold">20230908200000</span> <span style="color:#0000cf;font-weight:bold">11019</span> . M02FKEukwDc7T/KjNtpdCfwvkzHx1STqPt3AO/eXQxqBU7jN9vrHbJMJ PNXpBlO5p+HgnZ9w0c7sR8qnDXFl1OziNAo0el1fRq0YFwBae9BgoLCg IeZVoZmqerXpVXCrpKX1Fb+ILjuIX1bL5li2xQ/gpq4u91EijGvZg6sQ UmBiQW0JlXKR927uOm+aJHN6Ujnzd7sZrOWpSXQAOVPf4dHjvCJNohfs V9cJkjBRI+QuOpArJ+gCGKoiMidjYZBuYXIsYV7PYLQbVfVZg2E3JFXX h5BkqZUlCZbabAcVCzQ6BGZMpxcs1A/J8g/7+eguU6bJFpbiBXeHEZhx <span style="color:#000">TS1zoQ</span><span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">1173</span> bytes from 192.58.128.30#53<span style="color:#ce5c00;font-weight:bold">(</span>j.root-servers.net<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">8</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通用顶级域名返回 baidu.com. 域的 DNS 服务器名字列表</span>
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns2.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns3.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns4.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns1.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns7.baidu.com.
</span></span><span style="display:flex;"><span>CK0POJMG874LJREF7EFN8430QVIT8BSM.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN NSEC3 <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">0</span> - CK0Q2D6NI4I7EQH8NA30NS61O48UL8G5 NS SOA RRSIG DNSKEY NSEC3PARAM
</span></span><span style="display:flex;"><span>CK0POJMG874LJREF7EFN8430QVIT8BSM.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN RRSIG NSEC3 <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">86400</span> <span style="color:#0000cf;font-weight:bold">20230915042421</span> <span style="color:#0000cf;font-weight:bold">20230908031421</span> <span style="color:#0000cf;font-weight:bold">4459</span> com. ACWanRvoDIwYH40J5TjA8G6UXUldpz8+aNZdFlLO1eY9GRalvfLnpa6H RqiP03pvORSpHJEv2+HuQ1HtWTCj/nlJOeiRKG0Bk/HjcjkH9yv1b6pF ASeyvdJYN2wYPp4e1KPVe3GuoxBETq6kPKfUhR289IzQFy5vLgIfeVWK <span style="color:#000">pR6z0kgCFKTKaO21nj2LxxWsxmfuIpe8ztJuPTF7lVhXhw</span><span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span>HPVV0C47Q7CQMTAJM90K1FBFJBRP4B4D.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN NSEC3 <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">0</span> - HPVVAN8CFKHHHMEIDVJHFNQEOI5G6C89 NS DS RRSIG
</span></span><span style="display:flex;"><span>HPVV0C47Q7CQMTAJM90K1FBFJBRP4B4D.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN RRSIG NSEC3 <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">86400</span> <span style="color:#0000cf;font-weight:bold">20230914060727</span> <span style="color:#0000cf;font-weight:bold">20230907045727</span> <span style="color:#0000cf;font-weight:bold">4459</span> com. oUS/iAWQKq/0KHQdg18vwuUvT1Ftl8tnpHZVCwdQPEaIq3gceZnmpE2Z u8pj+JPFOUqp/DWRNlWZYMmTuhSjJil7cCpahWk3+RJbeJQIWPtNvBkl BBmM1M3he1ELoS37YqcflA8U/q4CaNdEpIS7OiNy6f4efrkZMvqRZZ9U hRgI2CugaGb6C9mDeAfThooAqsc5xFCX9KjWGsNLr0pE+Q<span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">849</span> bytes from 192.48.79.30#53<span style="color:#ce5c00;font-weight:bold">(</span>j.gtld-servers.net<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">316</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ns3.baidu.com 返回 www.baidu.com 的解析结果</span>
</span></span><span style="display:flex;"><span>www.baidu.com.          <span style="color:#0000cf;font-weight:bold">1200</span>    IN      CNAME   www.a.shifen.com.
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">100</span> bytes from 153.3.238.93#53<span style="color:#ce5c00;font-weight:bold">(</span>ns3.baidu.com<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">24</span> ms
</span></span></code></pre></div><p>这是集中查询的抓包过程(建议在新 tab 中打开图片对比说明查看)</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-09-09-143516.png" alt=""></p>
<table>
<thead>
<tr>
<th>包序号</th>
<th>包功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>1, 2</td>
<td>从 10.8.0.1 DNS 服务器获得根服务器的地址</td>
</tr>
<tr>
<td>3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 24, 25, 26</td>
<td>向 192.168.1.1 和 10.8.0.1 查询根服务器的地址 (两个网卡都发送了查询请求)</td>
</tr>
<tr>
<td>14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 28, 29, 30, 31</td>
<td>10.8.0.1 和 192.168.1.1 返回 DNS 根服务器地址</td>
</tr>
<tr>
<td>26</td>
<td>向根服务器 <code>g.root-servers.net.</code> 查询 <code>www.baidu.com.</code> 的地址</td>
</tr>
<tr>
<td>32</td>
<td>根服务器 <code>g.root-servers.net.</code> 返回通用顶级域名列表及其地址 <code>[a-j].gtld-servers.net</code></td>
</tr>
<tr>
<td>33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45</td>
<td>向 10.8.0.1 查询通用顶级域名的 IP</td>
</tr>
<tr>
<td>47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59</td>
<td>10.8.0.1 返回通用顶级域名的 IP</td>
</tr>
<tr>
<td>46</td>
<td>向通用顶级域名 DNS server <code>i.gtld-servers.net</code> 查询 <a href="https://www.baidu.com">www.baidu.com</a> 的 IP</td>
</tr>
<tr>
<td>60</td>
<td><code>i.gtld-servers.net</code> DNS返回 <code>baidu.com.</code> 域的 DNS 服务器 <code>ns[12347].baidu.com</code> 的名字</td>
</tr>
<tr>
<td>61, 62, 63, 64, 65, 69</td>
<td>向 192.168.1.1 和 10.8.0.1 查询 <code>ns[12347].baidu.com</code> 的 IP</td>
</tr>
<tr>
<td>66,67,68,71,72,73</td>
<td>192.168.1.1 和 10.8.0.1 返回 <code>ns[12347].baidu.com</code> 的 IP</td>
</tr>
<tr>
<td>70</td>
<td>向 <code>ns2.baidu.com</code> 查询 <code>www.baidu.com</code> 的地址</td>
</tr>
<tr>
<td>74</td>
<td><code>ns2.baidu.com</code> 返回 <code>www.baidu.com</code> 的地址，它是 <code>www.a.shifen.com</code> 地址的别名</td>
</tr>
</tbody>
</table>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.cnblogs.com/pannengzhi/p/6262076.html">关于DNS,你应该知道这些</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-634110a9992b6264c18b7b4beda6f789">4 - 在 Ubuntu 22.04 上搭建 NFS Server</h1>
    
	<h2 id="环境准备">环境准备</h2>
<p>我准备了两台机器</p>
<table>
<thead>
<tr>
<th>name</th>
<th>ip</th>
<th>user</th>
<th>user_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>server</td>
<td>191.168.58.11</td>
<td>vagrant</td>
<td>1000</td>
</tr>
<tr>
<td>client</td>
<td>192.168.58.1</td>
<td>xuyundong</td>
<td>1000</td>
</tr>
</tbody>
</table>
<h2 id="安装组件">安装组件</h2>
<ul>
<li>服务端安装 nfs server</li>
</ul>
<pre tabindex="0"><code>sudo apt update
sudo apt install nfs-kernel-server
</code></pre><ul>
<li>客户端安装 nfs-common</li>
</ul>
<pre tabindex="0"><code>sudo apt update
sudo apt install nfs-common
</code></pre><h2 id="服务端创建目录并导出">服务端创建目录并导出</h2>
<h3 id="在服务端上创建挂载目录并设置权限">在服务端上创建挂载目录，并设置权限</h3>
<pre tabindex="0"><code>sudo mkdir -p /mnt/share
sudo chown vagrant:vagrant /mnt/share
sudo chmod 755 /mnt/share
</code></pre><h3 id="服务端上配置-nfs-export-目录">服务端上配置 nfs export 目录</h3>
<p>修改 <code>/etc/exports</code> 文件, 加入以下内容</p>
<pre tabindex="0"><code>/mnt/share       *(rw,async,no_subtree_check)
</code></pre><p>关于 export 选项的解释</p>
<ul>
<li><code>rw</code>: 客户端具有读和写的权限</li>
<li><code>sync</code>: 强制 nfs 在回复 client 之前将更改写入磁盘，这保证了 nfs server 的可靠性，但也降低了写入速度</li>
<li><code>no_subtree_check</code>: 此选项可防止子树检查，在子树检查过程中，主机必须为每个请求检查文件在导出的树中是否仍然可用。当客户端打开文件时重命名文件时，这可能会导致许多问题。<strong>通常建议禁用子树检查</strong>。</li>
<li><code>no_root_squash</code>: 当客户端以 root 权限写入文件时，nfs server 会将文件 owner 改成普通用户，当此选项开启时，nfs server 不修改 root 写入文件的 woner</li>
</ul>
<p>修改完以后执行以下命令载入配置</p>
<pre tabindex="0"><code>sudo systemctl restart nfs-kernel-server
</code></pre><h2 id="客户端挂载">客户端挂载</h2>
<p>客户端执行以下命令挂载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将服务端的 nfs 目录挂载到了客户端的 /home/xuyundong/tmp/nfs_exmaple 中</span>
</span></span><span style="display:flex;"><span>sudo mount 192.168.58.11:/mnt/share /home/xuyundong/tmp/nfs_exmaple
</span></span></code></pre></div><p>修改 <code>/etc/fstab</code> 文件，将以下内容写入可以让 client 在开机启动时自动挂载</p>
<pre tabindex="0"><code>192.168.58.11:/mnt/share   /home/xuyundong/tmp/nfs_exmaple   nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0
</code></pre><h2 id="测试访问">测试访问</h2>
<p>在客户端的目录中，<strong>以 uid=1000 的用户执行</strong></p>
<pre tabindex="0"><code>echo &#34;abc&#34; &gt; test.txt
</code></pre><p>可以看到文件正常写入了。</p>
<p>这是因为 client 的写入的用户的 uid 是 1000, server 中目录的 owner 的 uid 也是 1000, owner 相同就能正常写入。</p>
<h2 id="取消挂载">取消挂载</h2>
<p>客户端执行以下命令可以取消挂载</p>
<pre tabindex="0"><code>sudo umount ~/tmp/nfs_exmaple
</code></pre><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nfs-mount-on-ubuntu-22-04">How To Set Up an NFS Mount on Ubuntu 22.04</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd6083187c74288b0bc340d1a5d75a6f">5 - ls Tips</h1>
    
	<h2 id="ls-按照修改时间排序">ls 按照修改时间排序</h2>
<ul>
<li><code>-t</code> 按照修改时间排序</li>
<li><code>-r</code> 逆序排序</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xuyundong@Macmini:~/Github/blog$ ls -lt content/tips/
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong  <span style="color:#0000cf;font-weight:bold">800</span> 8月  <span style="color:#0000cf;font-weight:bold">16</span> 23:13 ls-tips.md.md
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong <span style="color:#0000cf;font-weight:bold">2644</span> 8月  <span style="color:#0000cf;font-weight:bold">16</span> 23:05 docker-registry.md
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong <span style="color:#0000cf;font-weight:bold">1990</span> 8月  <span style="color:#0000cf;font-weight:bold">11</span> 22:01 stty.md
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xuyundong@Macmini:~/Github/blog$ ls -lrt content/tips
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong <span style="color:#0000cf;font-weight:bold">1990</span> 8月  <span style="color:#0000cf;font-weight:bold">11</span> 22:01 stty.md
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong <span style="color:#0000cf;font-weight:bold">2644</span> 8月  <span style="color:#0000cf;font-weight:bold">16</span> 23:05 docker-registry.md
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong  <span style="color:#0000cf;font-weight:bold">897</span> 8月  <span style="color:#0000cf;font-weight:bold">16</span> 23:11 ls-tips.md.md
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d666840fe7c4f359e7566250aad67c80">6 - 查看信号的快捷键</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p><code>stty</code>命令的作用是 <code>change and print terminal line settings</code>，查看或修改 Linux 终端的配置。</p>
<p>今天遇到的需求是想查一下 <code>Ctrl-C</code> 按键发送的系统信号 ( <a href="https://man7.org/linux/man-pages/man7/signal.7.html">man 7 signal</a> )，搜了一下发现 stty 是最方便的查询命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; stty -a
</span></span><span style="display:flex;"><span>speed <span style="color:#0000cf;font-weight:bold">38400</span> baud<span style="color:#000;font-weight:bold">;</span> rows 68<span style="color:#000;font-weight:bold">;</span> columns 128<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">line</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">####################  我们主要关心这两行的内容</span>
</span></span><span style="display:flex;"><span><span style="color:#000">intr</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^C<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">quit</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^<span style="color:#4e9a06">\;</span> <span style="color:#000">erase</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^?<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">kill</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^U<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">eof</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^D<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">eol</span> <span style="color:#ce5c00;font-weight:bold">=</span> &lt;undef&gt;<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">eol2</span> <span style="color:#ce5c00;font-weight:bold">=</span> &lt;undef&gt;<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">swtch</span> <span style="color:#ce5c00;font-weight:bold">=</span> &lt;undef&gt;<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^Q<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^S<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">susp</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^Z<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">rprnt</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^R<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">werase</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^W<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">lnext</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^V<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">discard</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^O<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">min</span> <span style="color:#ce5c00;font-weight:bold">=</span> 1<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">####################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-parenb -parodd -cmspar cs8 -hupcl -cstopb cread -clocal -crtscts
</span></span><span style="display:flex;"><span>-ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr icrnl -ixon -ixoff -iuclc -ixany -imaxbel -iutf8
</span></span><span style="display:flex;"><span>opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
</span></span><span style="display:flex;"><span>isig icanon iexten <span style="color:#204a87">echo</span> echoe echok -echonl -noflsh -xcase -tostop -echoprt echoctl echoke -flusho -extproc
</span></span></code></pre></div><p>stty 输出的解释如下:</p>
<ul>
<li><code>^C</code> (<code>ctrl+c</code>) 发送 interrupt 信号</li>
<li><code>^\</code> (<code>ctr+\</code>) 发送 quit 信号</li>
<li><code>^?</code> 清除上一个输入的字符</li>
<li><code>^U</code> 删除当前行</li>
<li><code>^D</code> 输入 EOF 字符(结束当前输入)</li>
<li><code>^S</code> 暂停输出</li>
<li><code>^Q</code> 在暂停输出后，重新开始输出</li>
<li><code>^Z</code> 发送一个 terminal stop 信号</li>
<li><code>^W</code> 删除最近输入的一个单词</li>
</ul>
<pre tabindex="0"><code>while true;do
    date;
    sleep 1
done
</code></pre><ul>
<li>(我用上面的代码测试 <code>^S</code> 和 <code>^Q</code>, 发现不生效)</li>
</ul>
<p>stty 其他输入的含义，请参考 <a href="https://linux.die.net/man/1/stty">man 1 stty</a></p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://unix.stackexchange.com/a/362579/191858">List of terminal generated signals (eg Ctrl-C -&gt; SIGINT)</a></li>
<li><a href="https://linux.die.net/man/1/stty">man 1 stty</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-549a76c189e9345d4226a12a7a7595fd">7 - Review 《File Descriptor Transfer over Unix Domain Sockets》</h1>
    
	<blockquote>
<ul>
<li><strong>使用 Unix 域套接字传输文件描述符</strong></li>
<li>原文地址: <a href="https://copyconstruct.medium.com/file-descriptor-transfer-over-unix-domain-sockets-dcbbf5b3b6ec">https://copyconstruct.medium.com/file-descriptor-transfer-over-unix-domain-sockets-dcbbf5b3b6ec</a></li>
</ul>
</blockquote>
<hr>
<blockquote>
<p><strong>12/31/2020 更新</strong></p>
<p>如果你使用的是较新的内核（Linux 5.6以上），随着一个新的系统调用 <code>pidfd_getfd</code> 的引入，这种复杂性大部分已经被消除了。更多细节请参考 2020年 12-31 发表的文章<a href="https://copyconstruct.medium.com/seamless-file-descriptor-transfer-between-processes-with-pidfd-and-pidfd-getfd-816afcd19ed4">《用 pidfd 和 pidfd_getfd 在进程间无缝传输文件描述符》</a>。</p>
</blockquote>
<p>昨天，我读了一篇惊人的论文，介绍了使用不同协议而且服务许多不同类型请求（长寿的TCP/UDP会话，涉及大块数据的请求等）的服务在Facebook是如何免中断发布的。</p>
<p>Facebook 使用的一种它们叫做 <code>Socket Takeover</code> 的技术。</p>
<p><code>Socket Takeover</code> 实现了 Proxygen 的零停机重启，它以并行方式启动了一个更新的实例，接管了监听的套接字，当旧的实例进入了优雅关闭阶段。新实例负责为新连接提供服务，并响应来自 L4LB Katran 的健康检查探针。老的连接由老的实例提供服务，直到完全关闭，之后其他机制（例如下游连接重用）开始发挥作用。</p>
<p>当我们把一个打开的FD从旧的进程传递给新的进程时，传递和接收的进程都共享监听套接字的同一个文件表项，并各自独立地处理接收的连接，在这些连接上提供连接级事务。我们利用了以下Linux内核的特性来实现这一点。</p>
<p><strong>CMSG</strong>：<code>sendmsg()</code> 的一个功能允许在本地进程之间发送控制信息（通常被称为辅助数据）。在 Level7 LB 进程的重启过程中，我们使用这一机制将所有 VIP ( Virtual IP of service) 的活动的监听套接字的 FD 集合从活动的实例发送至新启动的实例。这些数据是通过 <code>sendmsg</code> 和 <code>recvmsg</code> 在 UNIX 域套接字上交换的。</p>
<p><strong>SCM_RIGHTS</strong>: 我们设置这个选项来发送打开的文件描述符，其数据部分包含一个打开的FD的整数数组。在接收方，这些 文件描述符的行为就像它们是用 <code>dup(2)</code> 创建的一样。</p>
<p>我在 Twitter 上收到了一些人的回复，他们对这竟然是可能的表示惊讶。事实上，如果你对Unix域套接字的一些特性不是很熟悉，那么论文中的上述段落可能就很难理解了。</p>
<p>实际上，在 Unix 域套接字上传输 TCP 套接字是一种久经考验的方法，来实现 <strong>热重启</strong> 或 <strong>零停机时间重启</strong> 。流行的代理，如 HAProxy 和 Envoy ，使用非常类似的机制，将连接从代理的一个实例引流到另一个实例，而不丢弃任何连接。然而，许多类似的功能却并不广为人知。</p>
<p>在这篇文章中，我想探讨 Unix 域套接字的一些特性，这些特性使它成为这些场景下的合适候选者，特别是将套接字（或任何文件描述符）从一个进程转移到另一个进程，在这两个进程之间不一定存在父子关系。</p>
<h2 id="unix-域套接字">Unix 域套接字</h2>
<p>众所周知，Unix 域套接字允许同一主机系统上的进程之间进行通信。Unix域套接字在许多流行的系统中都有使用。HAProxy、Envoy、AWS的 Firecracker 虚拟机监视器、Kubernetes、Docker和 Istio 等等。</p>
<h3 id="一个简短的教程">一个简短的教程</h3>
<p>就像网络套接字一样，Unix 域套接字也支持流和数据报文类型。然而，与采用 IP 和端口作为地址的网络套接字不同，Unix域套接字使用路径名作为地址。与网络套接字不同，Unix域套接字的 I/O 不涉及对底层设备的操作（这使得Unix域套接字与网络套接字相比，在同一主机上执行IPC要快很多）。</p>
<p>用 <code>bind(2)</code> 将一个名字绑定到一个Unix域套接字，在文件系统中创建一个名为 <code>pathname</code> 的套接字文件。然而，这个文件与你可能创建的任何普通文件不同。</p>
<p>一个简单的Go程序在 Unix 域套接字上创建一个监听的 &ldquo;Echo 服务器&rdquo;，如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">addr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/tmp/uds.sock&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">l</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Accept</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果你建立并运行这个程序，可以观察到几个有趣的事实。</p>
<h3 id="socket-文件--普通文件">Socket 文件 != 普通文件</h3>
<p>首先，套接字文件 <code>/tmp/uds.sock</code> 被标记为一个套接字。当使用 <code>stat()</code> 调用查看这个路径名时，它在stat结构的<code>st_mode</code>字段的文件类型部分返回值 <code>S_IFSOCK</code> 。</p>
<p>当用<code>ls -l</code>查看时，UNIX 域套接字在第一列显示为s类型，而 <code>ls -F</code> 在套接字路径名上附加一个等号（=）。</p>
<pre tabindex="0"><code>root@1fd53621847b:~/uds# ./uds
^C
root@1fd53621847b:~/uds# ls -ls /tmp
total 0
0 srwxr-xr-x 1 root root 0 Aug  5 01:45 uds.sock
root@1fd53621847b:~/uds# stat /tmp/uds.sock
File: /tmp/uds.sock
Size: 0          Blocks: 0          IO Block: 4096   socket
Device: 71h/113d Inode: 1835567     Links: 1
Access: (0755/srwxr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2020-08-05 01:45:41.650709000 +0000
Modify: 2020-08-05 01:45:41.650709000 +0000
Change: 2020-08-05 01:45:41.650709000 +0000

Birth: -

root@5247072fc542:~/uds# ls -F /tmp
uds.sock=
root@5247072fc542:~/uds#
</code></pre><p>对文件起作用的普通系统调用在套接字文件上不起作用：这意味着像 <code>open()</code> 、<code>close()</code> 、<code>read()</code> 这样的系统调用不能用于套接字文件。相反，像 <code>socket()</code> 、<code>bind()</code> 、<code>recv()</code> 、<code>sendmsg()</code> 、<code>recvmsg()</code> 等套接字相关的系统调用可以在 Unix域套接字上工作。</p>
<p>另一个关于套接字的有趣事实是，它不是在套接字被关闭的时候删除，而是通过系统调用来删除</p>
<ul>
<li>在 MacOS 上调用 <code>unlink(2)</code></li>
<li>在 Linux 上调用 <code>remove()</code> 或使用地更普遍的 <code>unlink(2)</code></li>
</ul>
<p>在 Linux 上，Unix 域套接字的地址通过如下的结构来表示:</p>
<pre tabindex="0"><code>struct sockaddr_un {
      sa_family_t sun_family; /* Always AF_UNIX */
      char sun_path[108]; /* Pathname */
};
</code></pre><p>在 MacOS 上，地址通过如下的结构表示:</p>
<pre tabindex="0"><code>struct sockaddr_un {
     u_char  sun_len;
     u_char  sun_family;
     char    sun_path[104];
};
</code></pre><h3 id="使用-bind2-绑定一个已经存在的路径将会失败">使用 bind(2) 绑定一个已经存在的路径将会失败</h3>
<p><code>SO_REUSEPORT</code> 选项允许任何指定主机上的多个网络套接字连接到同一地址和端口。第一个试图绑定给定端口的套接字需要设置 <code>SO_REUSEPORT</code> 选项，任何后续的套接字都可以绑定到同一端口。</p>
<p>对 <code>SO_REUSEPORT</code> 的支持是在 Linux 3.9及以上版本中引入的。然而，在 Linux 上，所有想共享同一地址和端口组合的套接字必须属于共享同一有效UID的进程。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">socket</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">domain</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">socktype</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">optval</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">setsockopt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SOL_SOCKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SO_REUSEPORT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">optval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">optval</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sockaddr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addrlen</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>然而，两个 Unix 域套接字无法绑定相同的路径。</p>
<h2 id="socketpair">SOCKETPAIR</h2>
<p><code>socketpair()</code> 函数创建了两个套接字，然后将其连接在一起。从某种程度上说，这与 <strong>管道</strong> 非常相似，只是它支持数据的双向传输。</p>
<p><code>socketpair</code> 只对 Unix 域套接字起作用。它返回两个已经连接在一起的文件描述符（所以我们不必在开始传输数据之前
, 执行 <code>socket</code> -&gt; <code>bind</code> -&gt; <code>listen</code> -&gt; <code>accept</code>的流程来建立一个监听套接字。也不必在开始传输数据之前，执行 <code>socket</code> -&gt; <code>connect</code> 的流程创建一个连接到监听套接字的客户端）。</p>
<h2 id="在-unux-域套接字上传输数据">在 Unux 域套接字上传输数据</h2>
<p>现在我们已经确定 Unix 域套接字允许同一主机上的两个进程进行通信，现在是时候探索什么样的数据可以通过 Unix 域套接字传输。</p>
<p>由于Unix域套接字在许多方面与网络套接字相似，任何通常可以通过网络套接字发送的数据都可以通过Unix域套接字发送。</p>
<p>此外，特殊的系统调用 <code>sendmsg</code> 和 <code>recvmsg</code> 允许在Unix域套接字上发送一个特殊的消息。这个消息由内核特别处理，它允许从发送者向接收者传递打开的 <strong>File Descriptions</strong>。</p>
<h3 id="file-descriptors文件描述符-vs-file-description-文件描述">File Descriptors(文件描述符) VS File Description (文件描述)</h3>
<p>注意上一段我使用了术语 文件描述(<code>File descripTION</code>)，而不是文件描述符 (<strong>file descripTOR</strong>)。它们两者的区别是微妙的而且往往不被人理解。</p>
<p>文件描述符实际上只是一个进程内(不可跨进程使用)指向底层内核数据结构的指针，该结构被称为文件描述（<strong>File Description</strong>）。内核维护着一个所有打开的文件描述的表格，称为打开文件表(<strong>open file table</strong>)。如果两个进程（A和B）试图打开同一个文件，这两个进程可能有自己独立的文件描述符，它们指向开放文件表中的同一个文件描述。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-11-30-142542.png" alt="img"></p>
<p>所以，在 Unix 域套接字上使用 <code>sendmsg</code> 发送文件描述符实际上意味着发送 <strong>文件描述</strong> 的引用。如果进程 A 向 进程 B 发送文件描述符 0 (fd0)，该文件描述符在进程 B 中很可能被数字3(fd3) 所引用。</p>
<p>发送进程在 Unix 域套接字上调用 <code>sendmsg</code> 发送文件描述符，接收进程在 Unix 域套接字上调用 <code>recvmsg</code> 来接受文件描述符。</p>
<p>发送进程通过 <code>sendmsg</code> 发送文件描述给接收进程，接收进程通过 <code>recvmsg</code> 接收该文件描述。即使发送进程在发送完成后关闭了该文件描述所对应的文件描述符，而接收进程还未调用 <code>recvmsg</code> 接收它，该文件描述依然对接收进程保持打开状态。</p>
<p><strong>发送文件描述符时，文件描述的引用次数会+1,直到文件描述的引用次数下降到0, 内核才会将文件描述从 <code>打开文件表(open file table)</code> 中删除该文件描述。</strong></p>
<p>即使发送进程在接收进程调用 recvmsg 之前关闭了引用通过 sendmsg 传递的文件描述的文件描述符，该文件描述符仍然对接收进程开放。发送描述符时，描述符的引用次数会增加1。内核只有在引用计数下降到0时才会从其开放文件表中删除文件描述。</p>
<h3 id="sendmsg-和-recvmsg">sendmsg 和 recvmsg</h3>
<p>在 Linux 中 <code>sendmsg</code> 函数的签名如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ssize_t</span> <span style="color:#000">sendmsg</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">socket</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>与 <code>sendmsg</code> 对应的是 <code>recvmsg</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ssize_t</span> <span style="color:#000">recvmsg</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sockfd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>人们可以用 <code>sendmsg</code> 在 Unix 域套接字上传输的特殊消息是由 <code>msghdr</code> 指定的。希望将文件描述发送给另一个进程的进程创建一个 <code>msghdr</code> 结构，其中包含要传递的描述。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span>            <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg_name</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* optional address */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">socklen_t</span>       <span style="color:#000">msg_namelen</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* size of address */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span>          <span style="color:#000">iovec</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg_iov</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* scatter/gather array */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>             <span style="color:#000">msg_iovlen</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* # elements in msg_iov */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span>            <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg_control</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* ancillary data, see below */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">socklen_t</span>       <span style="color:#000">msg_controllen</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* ancillary data buffer len */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>             <span style="color:#000">msg_flags</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* flags on received message */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p><code>msghdr</code> 结构的 <code>msg_control</code> 成员，其长度为 <code>msg_controllen</code> ，指向一个如下形式的消息缓冲区:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">socklen_t</span> <span style="color:#000">cmsg_len</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* data byte count, including header */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>       <span style="color:#000">cmsg_level</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/* originating protocol */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>       <span style="color:#000">cmsg_type</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* protocol-specific type */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* followed by */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">cmsg_data</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>在 POSIX 中，带有附加数据的 <code>cmsghdr</code> 结构的缓冲区被称为辅助数据(ancillary data)。在 Linux 上，每个套接字允许的最大缓冲区大小可以通过修改 <code>/proc/sys/net/core/optmem_max</code> 来设置。</p>
<h2 id="辅助数据传输">辅助数据传输</h2>
<p>虽然这种数据传输有大量的陷阱，但如果使用得当，它可以成为一个相当强大的机制来实现一些目标。</p>
<p>在Linux上，有三种类型的辅助数据可以在两个Unix域套接字之间共享。</p>
<ul>
<li><code>SCM_RIGHTS</code></li>
<li><code>SCM_CREDENTIALS</code></li>
<li><code>SCM_SECURITY</code></li>
</ul>
<p>这三种类型的辅助数组仅应该通过下面的宏定义来访问，而不应该直接使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CMSG_FIRSTHDR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msgh</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CMSG_NXTHDR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msgh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cmsg</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">CMSG_ALIGN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">CMSG_SPACE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">CMSG_LEN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CMSG_DATA</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cmsg</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>我从来没有使用后两者的需要，<code>SCM_RIGHTS</code> 是我希望在这篇文章中进一步探讨的。</p>
<h3 id="scm_rights">SCM_RIGHTS</h3>
<p><code>SCM_RIGHTS</code> 允许进程使用 <code>sendmsg/recvmsg</code> 从另一个进程发送/接收一组打开的文件描述符。</p>
<p><code>cmsghdr</code> 结构体的成员 <code>cmsg_data</code> 可以包含一个进程想要发送的文件描述符的数组。</p>
<pre tabindex="0"><code>struct cmsghdr {
    socklen_t cmsg_len;    /* data byte count, including header */
    int       cmsg_level;  /* originating protocol */
    int       cmsg_type;   /* protocol-specific type */
    /* followed by */
    unsigned char cmsg_data[];
};
</code></pre><p>接收进程使用 <code>recvmsg</code> 接收数据。</p>
<p>《Linux Programming Interface》有一个使用 <code>sendmsg</code> 和 <code>recvmsg</code> 函数的<a href="https://man7.org/tlpi/code/online/dist/sockets/scm_rights_send.c.html">良好示例</a>。</p>
<h2 id="scm_rights-的陷阱">SCM_RIGHTS 的陷阱</h2>
<p>正如上文所讲，使用 Unix 域套接字传输辅助数据有很多的陷阱。</p>
<blockquote>
<p><strong>Need to send some “real” data along with the ancillary message</strong></p>
<p>需要在发送辅助数据的同时发送一些真实的数据</p>
</blockquote>
<p>在 Linux 上，如果想要成功地在 <strong>流式(stream)</strong> Unix 域套接字上发送辅助数据，至少要发送一个字节的真实数据。</p>
<p>然而，如果想要在 <strong>数据报式(datagram)</strong> 的 Unix 域套接字上发送辅助数据，不需要发送任何附带的真实数据。也就是说，在通过数据报套接字发送辅助数据时，便携式应用程序还应该包括至少一个字节的真实数据。</p>
<blockquote>
<p>File Descriptors can be dropped</p>
<p>文件描述符可以被丢弃</p>
</blockquote>
<p>如果用于接收包含文件描述符的辅助数据的缓冲区 <code>cmsg_data</code> 太小（或没有），那么辅助数据被截断（或丢弃），多余的文件描述符在接收进程中被自动关闭。</p>
<p>如果在辅助数据中收到的文件描述符的数量导致进程超过其 <code>RLIMIT_NOFILE</code> 资源限制，则多余的文件描述符将在接收进程中自动关闭。不能在多个 <code>recvmsg</code> 调用中分割列表。</p>
<blockquote>
<p>recvmsg quirks</p>
<p>recvmsg 的怪异情况</p>
</blockquote>
<p><code>sendmsg</code> 和 <code>recvmsg</code> 的作用类似于 <code>send</code> 和 <code>recv</code> 系统调用，在每个 <code>send</code> 调用和每个 <code>recv</code> 调用之间没有1：1的映射。</p>
<p>一个 <code>recvmsg</code> 调用可以从多个 <code>sendmsg</code> 调用中读取数据。同样地，它可能需要多个<code>recvmsg</code>调用来消耗一个<code>sendmsg</code> 调用所发送的数据。这有严重的、令人惊讶的影响，其中一些已经在这里报告。</p>
<blockquote>
<p>Limit on the number of File Descriptions</p>
<p>文件描述符的数量限制</p>
</blockquote>
<p>内核常量 <code>SCM_MAX_FD</code> ( 253 (或者在2.6.38之前的内核中为255))定义了数组中文件描述符的数量限制。</p>
<p>试图发送一个大于这个限制的数组会导致 <code>sendmsg</code> 失败，错误是 <code>EINVAL</code>。</p>
<h2 id="什么时候发送文件描述符是有用的">什么时候发送文件描述符是有用的</h2>
<p>一个非常具体的现实世界的使用案例是零停机时间的代理重载。</p>
<p>任何曾经使用过HAProxy的人都可以证明，&ldquo;零停机时间的配置重载 &ldquo;在很长一段时间内并不是一个真正的东西。通常，大量的<a href="https://engineeringblog.yelp.com/2015/04/true-zero-downtime-haproxy-reloads.html">Rube Goldberg-esque</a> Hack 被用来实现这一目标。</p>
<p>在2017年底，HAProxy 1.8 支持无中断重载，通过将监听套接字文件描述符从旧的 HAProxy 进程转移到新的进程中来实现。Envoy使用 <a href="https://blog.envoyproxy.io/envoy-hot-restart-1d16b14555b5">类似的机制</a> 进行热重启，文件描述符通过Unix域套接字传递。</p>
<p>2018年底，Cloudflare 在<a href="https://blog.cloudflare.com/know-your-scm_rights/">博客</a> 中介绍了其使用的将文件描述符从nginx转移到Go TLS 1.3代理。</p>
<p>促使我写下这篇博文的关于Facebook如何实现零停机发布的论文，使用了与 <code>CMSG + SCM_RIGHTS</code> 相同的技巧，将活的文件描述符从将要结束的进程传递到新发布的进程。</p>
<h2 id="总结">总结</h2>
<p>如果使用得当，通过Unix域套接字传输文件描述符可以被证明是非常强大的。我希望这篇文章能让你对Unix域套接字和它的功能有一个更好的理解。</p>
<h2 id="references">References:</h2>
<ul>
<li><a href="https://www.man7.org/linux/man-pages/man7/unix.7.html">https://www.man7.org/linux/man-pages/man7/unix.7.html</a></li>
<li><a href="https://blog.cloudflare.com/know-your-scm_rights/">https://blog.cloudflare.com/know-your-scm_rights/</a></li>
<li>LWN.net has an interesting article on creating cycles when passing file descriptions over a Unix domain socket and implications for the fabulous new io_uring kernel API. <a href="https://lwn.net/Articles/779472/">https://lwn.net/Articles/779472/</a></li>
<li>The Linux Programming Interface <a href="https://learning.oreilly.com/library/view/the-linux-programming/9781593272203/">https://learning.oreilly.com/library/view/the-linux-programming/9781593272203/</a></li>
<li>UNIX Network Programming: The Sockets Networking API <a href="https://learning.oreilly.com/library/view/the-sockets-networking/0131411551/">https://learning.oreilly.com/library/view/the-sockets-networking/0131411551/</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-50e13d0c712358d46277160b2eed624c">8 - Glob 语法解析</h1>
    
	<p>Glob 语法</p>
<hr>
<h2 id="tips">Tips</h2>
<table>
<thead>
<tr>
<th>通配符</th>
<th>描述</th>
<th>例子</th>
<th>匹配</th>
<th>不匹配</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*</code></td>
<td>匹配任意数量的任何字符，包括无</td>
<td><code>Law*</code></td>
<td>Law, Laws, Lawyer</td>
<td>GrokLaw, La, aw</td>
</tr>
<tr>
<td>?</td>
<td>匹配任何 单个 字符</td>
<td>?at</td>
<td>Cat, cat, Bat, bat</td>
<td>at</td>
</tr>
<tr>
<td>[abc]</td>
<td>匹配括号中给出的一个字符</td>
<td>[CB]at</td>
<td>Cat, Bat</td>
<td>cat, bat</td>
</tr>
<tr>
<td>[a-z]</td>
<td>匹配括号中给出的范围中的一个字符</td>
<td>Letter[0-9]</td>
<td>Letter0, Letter1 … Letter9</td>
<td>Letters, Letter, Letter10</td>
</tr>
<tr>
<td>[!abc]</td>
<td>匹配括号中未给出的一个字符</td>
<td>[!C]at</td>
<td>Bat, bat, cat</td>
<td>Cat</td>
</tr>
<tr>
<td>[!a-z]</td>
<td>匹配不在括号内给定范围内的一个字符</td>
<td>Letter[!3-5]</td>
<td>Letter1…</td>
<td>Letter3 … Letter5, Letterxx</td>
</tr>
</tbody>
</table>
<ul>
<li>Gitignore</li>
</ul>
<p>git 的 .gitignore 文件可以使用 glob 模式匹配， 另外还有一些规则：</p>
<p>所有空行或者以 # 开头的行都会被 Git 忽略
匹配模式可以以 / 开头防止递归
匹配模式可以以 / 结尾指定目录
要忽略指定模式以外的文件或目录，可以在模式前加上惊叹号 ! 取反</p>
<ul>
<li>Python</li>
</ul>
<p>Python 有进行 glob 匹配的标准库， 使用也很简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">glob</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># glob 只有两个函数， 功能差不多， 只不过一个返回列表， 一个返回迭代器</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">glob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">glob</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;*.org&#39;</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># 返回所有后缀名为 .org 的文件</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">glob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">iglob</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;*/&#39;</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># 返回匹配所有目录的迭代器</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://rgb-24bit.github.io/blog/2018/glob.html">Glob 语法及解析</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-efaf8b11c2c533130e7721f968b66120">9 - 词法分析器生成工具 Lex 简介</h1>
    
	<blockquote>
<p>结合例子简单介绍了Lex 程序和 Lex 工具的用法</p>
</blockquote>
<hr>
<h2 id="lex-说明">Lex 说明</h2>
<p>Lex 是一个词法分析器的生成工具，它支持使用正则表达式来描述各个词法单元的模式，由此给出一个词法分析器的规约，并生成相应的实现代码。
Lex 程序的输入方法称为 Lex 语言，而 Lex 程序本身被称为 Lex 编译器，Flex 是 Lex 编译器的一种替代实现( lex，flex 的关系和 cc，gcc 的关系很相似)。</p>
<p>在本文中，我们将会介绍 Lex 语言，并书写一个简单的 Lex 程序，进行词法分析，并输出分析结果。</p>
<h2 id="lex-程序的使用">Lex 程序的使用</h2>
<p>Lex 程序的使用方法如下图所示:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-12-15-101534.jpg" alt=""></p>
<ol>
<li>通过 lex 语言写一个 lex 源程序 lex.l</li>
<li>使用 Lex 编译器 flex 将 lex.l 编译成 C 代码, lex.yy.c</li>
<li>通过 C 编译器 cc 将 lex.yy.c 编译成可执行程序</li>
<li>运行可执行程序，输入源程序，输出词法单元序列</li>
</ol>
<h2 id="lex-程序的结构">Lex 程序的结构</h2>
<p>一个 Lex 程序通常具有如下形式:</p>
<pre tabindex="0"><code>声明部分
%%
转换规则
%%
辅助函数
</code></pre><h3 id="声明部分">声明部分</h3>
<p>声明部分通常包括<code>变量</code>，<code>明示常量</code>和正则表达式的定义，<code>明示常量</code>是一个值为数字的标识符，用来表示词法单元的类型。</p>
<h3 id="转换规则">转换规则</h3>
<p>转换规则具有如下的形式: <code>模式 { 动作 }</code>。每个模式是一个正则表达式，可以使用声明部分给出的正则定义。动作部分是代码片段，通常用 C 语言编写。</p>
<h3 id="辅助函数">辅助函数</h3>
<p>这个部分中定义了各个动作所需要的函数，也可以包含 main 函数，这部分的代码将会放到输出的 C 代码中。</p>
<h2 id="lex-程序的工作方式">Lex 程序的工作方式</h2>
<p>Lex 程序提供了一个函数<code>int yylex()</code>和两个变量<code>yyleng</code>，<code>yytext</code>供外部(通常是语法分析器)读取，调用。</p>
<p>当调用<code>yylex</code>的时候，程序会从<code>yyin</code>指针所指向的输入流中逐个读入字符，程序发现了最长的与某个模式 $P_i$ 匹配的字符串后，会将该字符串存入到<code>yytext</code>变量中，并设置<code>yyleng</code>变量为该字符串的长度，该字符串也就是词法分析程序分析出来的一个词法单元。</p>
<p>然后，词法分析程序会执行模式 $P_i$ 对应的动作 $A_i$，并使用<code>yylex</code>函数返回 $A_i$ 的返回值(通常是词法单元的类型)。</p>
<h2 id="词法分析的例子">词法分析的例子</h2>
<p>在下面的例子中，我们将会编写 Lex 程序，并生成生成一个词法分析器，分析 <code>test1.p</code> 程序，输出其词法单元和类型。</p>
<ul>
<li>test1.p</li>
</ul>
<pre tabindex="0"><code>while a &gt;= -1.2E-2
do b&lt;=2
</code></pre><h3 id="声明部分-1">声明部分</h3>
<p>首先定义的是声明部分，其中包含词法单元的类型，和一些正则表达式的定义</p>
<pre tabindex="0"><code class="language-lex" data-lang="lex">/* 明示常量的定义 */
#define IF 1
#define THEN 2
#define ELSE 3
#define ID 4
#define NUMBER 5
#define RELOP 6
#define DO 7
#define WHILE 8

%}

/* 正则表达式的定义 */
delim       [ \t\n]
ws          {delim}+
letter      [A-Za-z]
digit       [0-9]
id          {letter}({letter}|{digit})*
number      [+-]?{digit}+(\.{digit}+)?(E[+-]?{digit}+)?
</code></pre><p>需要注意的是，正则表达式中使用大括号包裹起来的内容表示嵌入另外一个正则表达式，例如<code>ws</code>的定义<code>{delim}+</code>就表示将之前定义的正则表达式<code>delim</code>嵌入进来。</p>
<h3 id="转换部分">转换部分</h3>
<p>然后是转换部分，定义如下:</p>
<pre tabindex="0"><code class="language-lex" data-lang="lex">{ws}        {  }
if          { return(IF); }
then        { return(THEN); }
while       { return(WHILE); }
do          { return(DO); }
else        { return(ELSE); }
{id}        { return(ID); }
{number}    { return(NUMBER); }
&#34;&lt;&#34;         { return(RELOP); }
&#34;&lt;=&#34;        { return(RELOP); }
&#34;&lt;&gt;&#34;        { return(RELOP); }
&#34;&gt;&#34;         { return(RELOP); }
&#34;&gt;=&#34;        { return(RELOP); }
&#34;=&#34;         { return(RELOP); }
</code></pre><p>这里的规则对应的动作都很简单，直接返回词法单元对应的类型。</p>
<h3 id="辅助函数-1">辅助函数</h3>
<p>最后是辅助函数部分，由于我们想输出一个可执行文件，所以这里会写一个 main 函数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">writeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">RELOP</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(RELOP, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">WHILE</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(WHILE, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">DO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(DO, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">NUMBER</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(NUM, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">ID</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(ID, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">yyin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fopen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#4e9a06">&#34;r&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Can&#39;t open file %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">yyout</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">fopen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#4e9a06">&#34;w&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* yyin和yyout是lex中定义的输入输出文件指针，它们指明了
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * lex生成的词法分析器从哪里获得输入和输出到哪里。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 默认：stdin，stdout。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yylex</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">writeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fclose</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyin</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">fclose</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们在 main 函数中调用<code>yylex</code>函数获取到一个词法单元，然后调用<code>writeout</code>函数，将这个词法单元及其类型，输出到<code>stdout</code>中。</p>
<h3 id="程序的编译执行">程序的编译执行</h3>
<p>将上述程序写入到 lex.l 中，在 Mac 系统上，执行以下命令:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>// flex 可以通过 brew install flex 安装
</span></span><span style="display:flex;"><span>flex lex.l
</span></span><span style="display:flex;"><span>cc lex.yy.c -o lex -ll
</span></span></code></pre></div><p>上述程序会生成可执行文件<code>lex</code>，然后我们执行 <code>./lex test1.p</code>，就可以看到程序输出了词法单元及其类型。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; ./lex test1.p
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>WHILE, <span style="color:#4e9a06">&#34;while&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>ID, <span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>RELOP, <span style="color:#4e9a06">&#34;&gt;=&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>NUM, <span style="color:#4e9a06">&#34;-1.2E-2&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>DO, <span style="color:#4e9a06">&#34;do&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>ID, <span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>RELOP, <span style="color:#4e9a06">&#34;&lt;=&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>NUM, <span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>上述例子的完整代码可以在 <a href="https://github.com/bwangelme/simple_calc/tree/896cc28/lex_tutorial">Github@896cc28</a> 中找到。</p>
<h2 id="lex-中的冲突解决">Lex 中的冲突解决</h2>
<p>在 Lex 编译器解析输入流时，针对同一个字符串可能会有多种解析模式，例如上述例子中，<code>&lt;=</code>可以解析成<code>(RELOP, &quot;&lt;&quot;)</code>, <code>(RELOP, &quot;=&quot;)</code>，也可以解析成<code>(RELOP, &quot;&lt;=&quot;)</code>。当遇到这种冲突情况时，Lex 编译器遵循以下的规则:</p>
<ol>
<li>总是选择最长的前缀进行匹配</li>
<li>如果最长的可能前缀与多个模式匹配，总是选择在 Lex 程序中先被列出的模式。</li>
</ol>
<p>根据第二点可得，在上述例子中，<code>{id}</code>需要定义在<code>if</code>, <code>then</code>等关键字的后面，否则这些关键字就会被解析成 ID 了。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://book.douban.com/subject/3296317/">编译原理 3.5 节</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-25c9fa87749c3a8b80df79ec7693c21d">10 - 【流水账】利用闲置笔记本搭建自己的开发服务器</h1>
    
	<ol>
<li>对Ubuntu服务器进行基础配置</li>
<li>配置dnsmasq服务器</li>
<li>文章没什么技术含量，主要记录一些配置文件的位置</li>
</ol>
<h2 id="前言">前言</h2>
<p>最近新入手了一台MacBook Air，原来的ThinkPad就闲置下来了，感觉一直放着太浪费了，就重装了一个Ubuntu Server 16.04的系统，用来做自己的开发服务器。折腾了几个小时，就都搞定了，特意写下这篇文章，来记录一下自己折腾的过程。</p>
<h2 id="基础配置">基础配置</h2>
<p>服务器安装的过程就不说了，大都是那么几步。有一个奇怪的问题就是安装的时候，需要设置时区，我竟然没有找到东八区，只好先设置了一个太平洋时区，好尴尬，不知道是不是Ubuntu的文本安装界面没有东八区这个选项，还是我英文太差了，没有找到。</p>
<h3 id="设置时间">设置时间</h3>
<p>由于安装时我们设置了错误的时区，所以首先需要调整一下时区。Ubuntu 16.04已经完全集成了Systemd，所以我们只需要通过<code>sudo timedatectl set-timezone Asia/Shanghai</code>命令，就可以将时区设置为亚洲/上海了，同时我们也可以运行<code>sudo timedatectl set-ntp 1</code>命令，打开自动从 NTP 服务器同步时间，一会之后服务器时间就正常了。<code>timedatectl</code>命令还有一个选项是<code>set-local-rtc</code>，用来将硬件时间设置为本地时间，而不是UTC时间，这个选项我默认是关闭的。</p>
<h3 id="更改软件源为中科大源">更改软件源为中科大源</h3>
<p>接下来，就是更改源了，打开<code>/etc/apt/sources.list</code>文件，将所有的<code>us.archive.ubuntu.com</code>替换成<code>mirrors.ustc.edu.cn</code>就可以了，注意这里由于我安装的时候选择的是美国的源，所以域名为<code>us.archive.ubuntu.com</code>，如果选择了其他地方的源，域名可能不一样。</p>
<p>同时要注意，<code>security.ubuntu.com</code>这个源表示的是 Ubuntu 进行安全更新的源，用来推送紧急安全更新的补丁，这个源我建议保持原样，因为紧急安全更新的补丁还是从 Ubuntu 官方下载比较好，不建议从其他地方来下载。</p>
<h3 id="设置关闭盖子不休眠">设置关闭盖子不休眠</h3>
<p>由于我的电脑是笔记本，尽管没有装图形界面，但是在合上盖子之后，系统仍然会自动休眠，所以需要将这个自动休眠的功能关掉。我在网上搜索了一下，在 Askubuntu 上找到了一个相关的<a href="http://askubuntu.com/questions/141866/keep-ubuntu-server-running-on-a-laptop-with-the-lid-closed">问题</a>，按照问题中的答案所说，向<code>/etc/systemd/logind.conf</code>文件中添加一行<code>HandleLidSwitch=ignore</code>，然后重启<code>systemd-logind.service</code>服务，就关闭掉这个功能啦。</p>
<h2 id="配置网络环境">配置网络环境</h2>
<p>将服务器配置好以后，接下来我们就需要配置网络了。</p>
<h3 id="设置dhcp">设置DHCP</h3>
<p>我的笔记本是通过网线连接到路由器上的，所以，首先我们需要将有线网卡通过 DHCP 自动连接网络的功能打开。这里我在网上搜索了一下，搜到了一篇文章：<a href="http://www.ubuntugeek.com/ubuntu-networking-configuration-using-command-line.html">Ubuntu Networking Configuration Using Command Line </a>。这篇文章很详细地介绍了Ubuntu如何设置动态IP和静态IP。我的电脑在刚装好系统的时候，没有任何关于有线网卡的配置文件，仅能够通过<code>ip addr</code>命令来看到当前系统的网卡，在了解到有线网卡的名称为<code>enp12s0</code>之后，我新建了一个文件<code>/etc/network/interfaces.d/enp12s0.conf</code>，然后向其中添加了如下的内容，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置网卡enp12s0在开机的时候通过 DHCP 自动连接到网络。</span>
</span></span><span style="display:flex;"><span>auto enp12s0
</span></span><span style="display:flex;"><span>iface enp12s0 inet dhcp
</span></span></code></pre></div><p>上面两句配置就表示设置网卡enp12s0在开机的时候通过 DHCP 自动连接到网络。</p>
<h3 id="设置默认网关">设置默认网关</h3>
<p>设置好网卡的 DHCP 以后，我的服务器能够 ping 通路由器网关了，但是仍然无法 ping 通外网，显然，这是由于服务器本机的网关没有配置好，后来我又上网去搜索，发现了<a href="http://askubuntu.com/questions/522420/how-to-get-default-gateway-with-a-dhcp">Askubuntu 上一个类似的问题</a>，其中有个答案提到，<code>dhclient</code>只在当前服务器没有设置默认网关的时候，才会设置由 DHCP 服务器提供的路由器地址为默认网关。我通过<code>ip route</code>看了一下我的服务器的路由表，发现默认网关为网卡<code>lo</code>，所以 DHCP 服务器下发下来的网关地址并不会生效。我又在<code>/etc/network/interfaces</code>中添加了如下的配置：<code>post-up route del default dev lo</code>，删除掉默认走<code>lo</code>设备的路由配置。</p>
<p>然后我再来重启电脑，就发现服务器一开机就能够正常 ping 通外网了。</p>
<h3 id="设置路由器">设置路由器</h3>
<p>看到这里，相信大家肯定都有一些疑惑，服务器不应该是默认设置为静态IP吗，为什么你要配置 DHCP 呢。原因就在这一小节，我用的路由器是华硕的RT - N12，它的 DHCP 服务器有一个功能，就是将MAC地址和IP地址进行绑定，所以，我只需要在路由器上配置好MAC地址和IP地址的绑定，这样就相当于起到了静态IP的作用了，而且更改起来也比较方便，不需要服务器和路由器两头改。</p>
<h2 id="配置dns">配置DNS</h2>
<p>由于我访问我的服务器的时候想通过域名来访问(方便以后添加HTTPS证书)，所以我需要在我的内网中自己搭建一个DNS服务器，来负责服务器的域名解析。</p>
<h3 id="安装并设置dnsmasq">安装并设置dnsmasq</h3>
<p>由于我的需求很简单，只需要进行一个域名解析就可以了，所以我选择了<a href="http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html">dnsmasq</a>，而不是比较复杂的bind9。</p>
<p><code>dnsmasq</code>在Ubuntu的源中直接有deb安装包，所以我们直接通过<code>sudo apt install dnsmasq</code>命令安装即可。</p>
<p><code>dnsmasq</code>的配置我参考了文章<a href="http://cjting.me/misc/2016-08-20-%E4%BD%BF%E7%94%A8Dnsmasq%E6%90%AD%E5%BB%BA%E5%86%85%E7%BD%91DNS%E6%9C%8D%E5%8A%A1%E5%99%A8.html">使用Dnsmasq搭建内网DNS服务器</a>。使用了如下的配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置服务器的监听地址为192.168.X.X和127.0.0.1</span>
</span></span><span style="display:flex;"><span>listen-address<span style="color:#ce5c00;font-weight:bold">=</span>192.168.X.X,127.0.0.1
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 所有没有.号的域名(plain names)都不会向上游DNS Server转发，只查询hosts文件</span>
</span></span><span style="display:flex;"><span>domain-needed
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 所有保留IP地址段内的反向查询都不会向上游DNS Server转发，只查询hosts文件</span>
</span></span><span style="display:flex;"><span>bogus-priv
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不要读取/etc/resolver中的DNS Server的配置</span>
</span></span><span style="display:flex;"><span>no-resolv
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不要poll /etc/resolver文件的更新</span>
</span></span><span style="display:flex;"><span>no-poll
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置上游服务器为DNSPod的公共DNS</span>
</span></span><span style="display:flex;"><span><span style="color:#000">server</span><span style="color:#ce5c00;font-weight:bold">=</span>119.29.29.29
</span></span><span style="display:flex;"><span><span style="color:#000">server</span><span style="color:#ce5c00;font-weight:bold">=</span>182.254.116.116
</span></span></code></pre></div><p>配置好了以后，我们可以通过<code>dnsmasq --test</code>命令来检查<code>dnsmasq</code>的配置文件语法是否正确。</p>
<p>然后我们在服务器的<code>/etc/hosts</code>中添加我们想要设置的解析记录，比如这台服务器我设置了如下的记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>192.168.X.X dev.bwangel.me
</span></span></code></pre></div><p>然后通过<code>sudo systemctl enable dnsmasq &amp;&amp; sudo systemctl restart dnsmasq</code>命令启动<code>dnsmasq</code>服务即可。</p>
<p>最后我们可以通过<code>dig</code>命令测试一下，运行如下命令: <code>dig dev.bwangel.me @localhost</code>，看返回的IP地址是否和我们设置的解析记录相同。</p>
<h3 id="设置路由器-1">设置路由器</h3>
<p>配置好了DNS服务器以后，我们再来修改路由器的 DHCP 策略，设置下发的DNS服务器IP地址为我们的DNS服务器地址，这样内网中所有的DNS查询都会先经过这台DNS服务器。而我们的<code>dev.bwangel.me</code>域名也就能够成功解析了。至此，我们的开发服务器就已经搭建好了，我们可以通过SSH连接上来，搭建我们想要的服务了。</p>
<h2 id="遇到的一些小坑">遇到的一些小坑</h2>
<h3 id="dnsmasq没有绑定本地地址">dnsmasq没有绑定本地地址</h3>
<p>配置好了 DNS 服务器以后，我在服务器上 ping 百度的时候会一直卡着，但是 ping 公网 IP 却是可以 ping 通的，当时我第一反应就是DNS解析出错了，只是不知道是DNS服务器配置的有问题，还是DNS服务器的IP地址路由器没有正确地下发下来。</p>
<p>接着我就利用dig来测试，发现使用<code>dig www.baidu.com @192.168.X.X</code>命令可以得到正常结果，而<code>dig www.baidu.com @127.0.0.1</code>就会卡着。然后我就觉得应该是dnsmasq没有监听<code>127.0.0.1</code>导致的问题。最后发现服务器DNS的配置文件<code>/etc/resolv.conf</code>中设置的默认DNS为<code>127.0.0.1</code>，而它去查询<code>127.0.0.1</code>的时候会卡着，也不报错，导致服务器不会使用备选的DNS服务器来查询域名，最终导致出现了 ping 百度卡着这种情况。我将dnsmasq的监听地址加上<code>127.0.0.1</code>之后就OK了。</p>
<p>这里还有一点没有搞清楚，路由器的 DHCP 中配置的DNS服务器并没有正确地应用，服务器还是默认遵循<code>/etc/resolv.conf</code>文件中的配置，这个还需要进一步了解一下。</p>
<h3 id="ssh出现locale报错">ssh出现locale报错</h3>
<p>这个问题经常遇到了，在Mac上通过SSH连接到Ubuntu上之后，在安装更新的过程中，出现了如下的报错：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>perl: warning: Setting locale failed.
</span></span><span style="display:flex;"><span>perl: warning: Please check that your locale settings:
</span></span><span style="display:flex;"><span>    <span style="color:#000">LANGUAGE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">unset</span><span style="color:#ce5c00;font-weight:bold">)</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000">LC_ALL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">unset</span><span style="color:#ce5c00;font-weight:bold">)</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000">LC_MESSAGES</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;zh_CN.UTF-8&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000">LANG</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;zh_CN.UTF-8&#34;</span>
</span></span><span style="display:flex;"><span>    are supported and installed on your system.
</span></span><span style="display:flex;"><span>perl: warning: Falling back to the standard locale <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><p>这是由于终端SSH的时候，会将本地的locale配置传到服务端上去，我的本地设置的语系是<code>zh_CN.UTF-8</code>，但是服务器上只安装了<code>en_US.UTF-8</code>，所以就会报错提示说找不到语系<code>zh_CN.UTF-8</code>相关的文件。这里我们只需要修改一下服务器的<code>/etc/locale.gen</code>配置文件，将<code>zh_CN.UTF-8</code>相关的配置取消注释，然后再来运行<code>locale-gen</code>命令，就会安装上<code>zh_CN.UTF-8</code>语系相关的文件了，再来运行<code>perl</code>程序就不会报错了。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3b4ec5fedefcf82985dda74fa4bef98c">11 - 【非技术】 Arch 下的无线自动断开</h1>
    
	<p><strong>摘要</strong>:</p>
<blockquote>
<ol>
<li>折腾 ThinkPad E430 在 Arch WiFi 自动断开的问题</li>
<li>无线网卡型号推荐</li>
</ol>
</blockquote>
<h2 id="问题描述">问题描述</h2>
<p>首先说明，这个问题我最终还是没有解决，最后的办法就是去上网买了一块无线网卡，所以我在标题上写上非技术的字样，表明这篇文章技术含量并不大。</p>
<p>先说我的硬件环境吧，电脑是 ThinkPad E430，无线网卡的芯片型号是瑞昱的RTL8188CE，系统内核版本是4.8.13。</p>
<p>出现的问题就是无线连上一段时间以后，网络会自动断开，ping 不通任何网站。而系统却还显示网络已经连接，<code>ip address</code> 命令也能够看到无线网卡的IP地址。</p>
<h2 id="尝试的解决方案">尝试的解决方案</h2>
<h3 id="方案1更改etcpppoptions配置文件">方案1：更改<code>/etc/ppp/options</code>配置文件</h3>
<p>遇到问题当然要先谷歌啦，首先我以<code>arch wifi auto disconnect</code>关键字来搜索，结果搜到了很多相关度不大的页面，后来又以<code>thinkpad e430 wifi auto disconnect</code>关键字来搜索，就搜索到了<a href="https://www.oschina.net/question/571626_234750">开源中国社区上的一个问题</a>，额，前两个回答看起来还是让人很不爽的，不禁让我想起来教主的这条<a href="http://weibo.com/1401527553/EirySEJV9?type=comment">微博</a>，然后果断举报了。</p>
<p>接着我在下面看到有人回答说可以更改<code>/etc/ppp/options</code>文件中的一个配置项，我就照着去更改了，重启后发现该 WiFi 依旧抽风，方案1失败。</p>
<h3 id="方案2更改rtl8192ce内核模块的选项">方案2：更改<code>rtl8192ce</code>内核模块的选项</h3>
<p>后来我一想，是不是因为我的搜索关键字范围太广了，就把关键字搞得更精确一点。我就去以<code>RTL8188CE linux disconnect</code>和<code>RTL8188CE linux disconnect</code>着两个关键字去搜索，果然一下子发现了有价值的内容。</p>
<p>首先找到了是这个帖子：<a href="https://forums.linuxmint.com/viewtopic.php?t=194086">【SOLVED】 wifi connection problems Realtek RTL8188CE</a>。发现这个帖子的时候，我感觉特别兴奋的，因为这位网友描述的问题，和我的几乎一模一样，它的网卡型号也和我的一模一样。
然后照着下面的回复，给<code>rtl8192ce</code>模块添加了<code>fwlps=0 ips=0</code>这两个参数，重启后发现依然跪，好吧，真是大坑。后来又去尝试编译这篇帖子中提到了<code>backports-20150313.tar.xz</code>程序，直接出现了语法错误，好吧，果断放弃了。</p>
<p>后来有搜索到了Arch论坛上有人讨论相关的问题，然后我就照着论坛里面人们的讨论，稀里糊涂地发现了 ThinkPad E430 在 Arch 上的 <a href="https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_Edge_E430#Wireless">Wiki页面</a>。Wiki 中就提到了无线网络的问题，然后它给出的答案也是更改<code>RTL8188CE</code>这个内核模块的参数，不过是只需要添加一个<code>fwlps=0</code>就好了，如果不行的话，直接去买一块 Intel Centrino wlan/bluetooth 4.0 卡吧。
我照着这个方案试了一下，果断不行，WiFi 依然跪，方案2也失败了。</p>
<h3 id="方案3求助于-archlinux-的邮件列表">方案3：求助于 ArchLinux 的邮件列表</h3>
<p>到此时，我已经感觉到山穷水尽了，好像真的没有办法了，于是乎就去 ArchLinux 邮件列表上发了一个<a href="https://groups.google.com/forum/#!topic/archlinux-cn/UgGVBn99UOs">求助帖</a>：一方面想看看还能不能找到解决办法，另一方面想请教一下如果要再买一个无线网卡的话，该买什么型号的？</p>
<h2 id="原因分析">原因分析</h2>
<p>最后，在邮件列表中，大家分析过后，认为很有可能网卡驱动有问题。</p>
<p>因为在网络实际上已经断开的情况下，内核依然没有收到网络断开的消息，依然认为网络是连接着的。这种情况下可能的原因是：</p>
<ol>
<li>内核有 BUG 导致驱动报告的事件没有反应到其他部分。</li>
<li>驱动有 BUG 没有正确地将网络断开事件报告给内核。</li>
<li>驱动有 BUG 在网络已经断开的情况下没有报告网络已经断开这个事件。</li>
</ol>
<p>而一般看来，驱动是故障的高发区。</p>
<p>后来我又用 Wireshark 抓了一下包，发现当WiFI自动断开后，有大量的 ARP 请求，此时应该就是因为驱动有问题导致网卡罢工了，内核让它发的包发布出去，它也接受不到任何的包。</p>
<h2 id="网卡推荐">网卡推荐</h2>
<p>至此，看来这个驱动问题我是没法解决了，只好去重新买一块无线网卡，为了一个操作系统花上几十块钱买块网卡，虽说听起来很2，但是自己觉得还是很划算的。</p>
<p>目前无线网卡的芯片主要有这么几种：</p>
<ul>
<li>Ralink(雷凌，台湾)</li>
</ul>
<blockquote>
<p>Ralink Technology公司成立于2001年，总部位于台湾新竹，并在美国加州Cupertino设有研发中心。目前已知的Edimax、Tenda、ASUS及D-link都有采用Ralink的产品。</p>
</blockquote>
<ul>
<li>oroadcomd(博通，美国)</li>
</ul>
<blockquote>
<p>Broadcom芯片是最成熟、最稳定的一种，而且还可以使用DD-WRT这种第三方开源固件改善性能，增加功能。</p>
</blockquote>
<ul>
<li>Atheros(创锐讯，美国)</li>
</ul>
<blockquote>
<p>Atheros 在1999年由斯坦福大学的Teresa Meng博士和斯坦福大学校长，MIPS创始人John Hennessy博士共同在硅谷创办。Atheros的芯片被各大厂商所广泛采用，Netgear、D-Link、Intel等厂商均为Atheros客户。</p>
</blockquote>
<ul>
<li>Realtek(瑞昱，台湾)</li>
</ul>
<blockquote>
<p>瑞昱半导体于1987年在台湾的新竹科学园区成立，我的电脑的无线网卡芯片就是这个牌子的。</p>
</blockquote>
<p>总的来说，无论是抓包，开热点还是兼容性(不仅针对 Linux)，Atheros 的 AR9271 都是比较合适的。据同事说，使用下来最稳定的 USB 网卡就是网件的 WNA1100，某宝上二手的洋垃圾也就十几块钱。</p>
<h2 id="写在最后">写在最后</h2>
<p>最终我还是去某宝上买了一块 USB 无线网卡。再此，要感谢邮件列表中的热心群众，感谢他们能够帮我解决问题和推荐网卡，我从中也学到了很多。</p>
<p>最后附上我在解决问题的过程中参考到的页面：</p>
<ul>
<li><a href="https://www.oschina.net/question/571626_234750">ubuntu14.04 wifi频繁掉线</a></li>
<li><a href="https://forums.linuxmint.com/viewtopic.php?t=194086">【SOLVED】wifi connection problems Realtek RTL8188CE</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_Edge_E430#Wireless">Lenovo ThinkPad Edge E430 - Arch Wiki</a></li>
<li><a href="https://item.taobao.com/item.htm?spm=a230r.1.14.62.DbhWkt&amp;id=538494346626&amp;ns=1&amp;abbucket=19#detail">没错，你没有看错，这是一个淘宝页面，我参考了它的宝贝详情</a></li>
<li><a href="https://groups.google.com/forum/#!topic/archlinux-cn/UgGVBn99UOs">ArchLinux 的邮件列表</a></li>
</ul>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-end text-xs-center order-sm-3">
        
        
        
<ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/bwangelme/" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2">
        <span>&copy; 2023 力行近乎仁，好问近乎智，知耻近乎勇 </span>
        <span class="ms-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></span>
        
      </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
      integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ==" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
        integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g=="
        crossorigin="anonymous">
</script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
       integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin="anonymous"
       onload='renderMathInElement(document.body, null);'>
</script>
<script src="/647/js/main.min.4f6bdd3cd8cde411a9b8cc8c9f435ab27b7a07d49198bf6bc750cdcd26e6e429.js" integrity="sha256-T2vdPNjN5BGpuMyMn0Nasnt6B9SRmL9rx1DNzSbm5Ck=" crossorigin="anonymous"></script>
<script src='/647/js/prism.js'></script>
<script src='/647/js/tabpane-persist.js'></script>

  </body>
</html>
