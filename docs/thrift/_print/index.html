<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.115.2">
<link rel="canonical" type="text/html" href="https://bwangel.me/647/docs/thrift/">
<link rel="alternate" type="application/rss&#43;xml" href="https://bwangel.me/647/docs/thrift/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/647/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/647/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/647/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/647/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/647/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/647/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/647/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/647/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/647/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/647/favicons/android-192x192.png" sizes="192x192">

<title>Thrift | 647 Universe</title>
<meta name="description" content="宇宙很大，生活更大，也许以后还有缘相见">
<meta property="og:title" content="Thrift" />
<meta property="og:description" content="宇宙很大，生活更大，也许以后还有缘相见" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://bwangel.me/647/docs/thrift/" /><meta property="og:site_name" content="647号宇宙" />
<meta itemprop="name" content="Thrift">
<meta itemprop="description" content="宇宙很大，生活更大，也许以后还有缘相见"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Thrift"/>
<meta name="twitter:description" content="宇宙很大，生活更大，也许以后还有缘相见"/>




<link rel="preload" href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" as="style">
<link href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/647/css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/647/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">647 Universe</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/647/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/647/docs/thrift/"></a>.
</p>
</div>



<h1 class="title">Thrift</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-1af692bb57d127b768eb69b3abc8a667">Thrift golang client 如何设置超时时间</a></li>


    
  
    
    
	
<li>2: <a href="#pg-b127652654fb8cc62d6983427adc109f">Thrift 协议学习笔记</a></li>


    
  
    
    
	
<li>3: <a href="#pg-1bb16dc0ca8a634867ed72c7e903ba28">Thrft</a></li>


    
  
    
    
	
<li>4: <a href="#pg-d3ce439f30c5ecaccd3e7225d6be37c5">翻译《Chapter 1. Introduction to Apache Thrift》</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1af692bb57d127b768eb69b3abc8a667">1 - Thrift golang client 如何设置超时时间</h1>
    
	<h2 id="简介">简介</h2>
<p>本文以 golang thrift binary 协议为例，讲述 thrift golang client 如何设置超时时间</p>
<h2 id="如何设置超时时间">如何设置超时时间</h2>
<p>golang thrift client 有两个超时时间</p>
<ol>
<li>socket timeout</li>
</ol>
<p>在创建 TSocket 的时候，我们可以传入 <code>ConnectTimeout</code> 和 <code>SocketTimeout</code> 两个配置。</p>
<ul>
<li><code>ConnectTimeout</code> 表示建立 TCP 连接的超时时间</li>
<li><code>SocketTimeout</code> 表示读写 Socket fd 时的超时时间</li>
</ul>
<p>当这两个超时触发时，thrift 会返回一个 <code>err.Timeout() == true</code> 的 error, 表示超时错误，thrift 会将其包装成 <code>TTransportException</code>，其 <code>typeId == thrift.TIMED_OUT</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#000">rawTransport</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">thrift</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTSocketConf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JoinHostPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;7303&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">thrift</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TConfiguration</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SocketTimeout</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ConnectTimeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><ol start="2">
<li>context timeout</li>
</ol>
<p>在调用 thrift 函数时，需要传入 context 参数，我们可以在 ctx 参数中加上超时</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Triple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">27</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// thrift 调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>根据 context 的工作原理，</p>
<ol>
<li><code>cancel</code> 函数被调用</li>
<li>到了设置的超时时间，golang context 内部的的 goroutine 会调用 cancel 函数</li>
</ol>
<p>当上述两个条件满足其一时，会触发两个函数</p>
<ol>
<li><code>ctx.Done()</code> 返回的 channel 会 close</li>
<li><code>ctx.Error() != nil</code></li>
</ol>
<h2 id="设置超时时间的注意事项">设置超时时间的注意事项</h2>
<ol>
<li>socket timeout 必须比 context timeout 小</li>
<li>在弱网环境下，不能将 socket timeout 设置的非常小, context timeout 设置的特别大</li>
<li>遇到超时错误后应该将连接关闭</li>
</ol>
<p>为什么要遵循这些规则，我们先了解 timeout 工作原理，最后再来解答。</p>
<h2 id="超时时间是如何工作的">超时时间是如何工作的</h2>
<p>为了了解这两个超时时间是如何工作的，我们首先需要理清楚 binary protocol 中函数的调用关系</p>
<h3 id="binary-protocol-中的函数调用关系">binary protocol 中的函数调用关系</h3>
<p>在 <code>lib/go/thrift/protocol.go</code> 函数中，实现了 <code>TProtocol</code> 接口，此接口中定义了若干 ReadXXX 函数，这些函数负责从 Transport 中读取 thrift 请求体和响应体。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">TProtocol</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 若干 Write 函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ReadMessageBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typeId</span> <span style="color:#000">TMessageType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">seqid</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadMessageEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadStructBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadStructEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadFieldBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typeId</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">int16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadFieldEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadMapBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">keyType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">valueType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadMapEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadListBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">elemType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadListEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadSetBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">elemType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadSetEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadByte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadI16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadI32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadI64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadDouble</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadBinary</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadUUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#000">Tuuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>lib/go/thrift/binary_protocol.go</code> 文件提供了 <code>TProtocol</code> 的一种实现，它用于读取 <a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-binary-protocol.md">binary 协议格式</a>的 thrift 请求/响应。</p>
<p>其中, ReadXXX 函数的调用关系如下:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-09-05-215706.png" alt=""></p>
<p>可以看到，除了若干以 <code>End</code> 结尾的函数，和 <code>ReadByte</code>, <code>ReadBool</code> 之外，所有的 Read 函数都调用了 <code>readAll</code> 函数。</p>
<p>而关于 thrift 超时时间的玄机就隐藏在 <code>readAll</code> 函数中</p>
<h3 id="readall-函数中如何检查超时">readAll 函数中如何检查超时</h3>
<p>这是 <code>readAll</code> 函数的代码,</p>
<p><code>read, err = io.ReadFull(p.trans, buf)</code> 表示从 protocol 底层的 transport 读取数据，读完之后进行一个复杂的 if 条件判断，决定重试还是返回错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deadlineSet</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deadline</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">read</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadFull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trans</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">deadlineSet</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">read</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">isTimeoutError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Err</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// This is I/O timeout without anything read,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// and we still have time left, keep retrying.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// For anything else, don&#39;t retry
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewTProtocolException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>它的 if 条件有四个子条件</p>
<ol>
<li>ctx 设置了 deadline, 即 ctx 用 <code>WithTimeout</code>, <code>WithDeadline</code> 包裹了</li>
<li>protocol 底层的 transport 中读取的数据为0</li>
<li>protocol 底层的 transport 读取时返回的 err 是 timeout error</li>
<li>ctx 的 cancel 函数没有被调用(这也表示 WithTimeout ctx 没有超时)，<code>ctx.Err() == nil</code></li>
</ol>
<p>当四个条件都满足时，它会重新重试，重新从 tranport 中读取数据，否则会将错误返回。</p>
<p>至此，我们可以将 thrift 客户端的超时逻辑梳理清楚了，protocol 通过 transport 去读取数据，当它遇到了 timeout error，但没有读到数据且 ctx 设置的超时时间未到，会重试继续读数据。否则就会返回超时错误。</p>
<p>我们可以用下面这张图来表示</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-09-05-222326.png" alt=""></p>
<ul>
<li><strong>step1</strong> 表示从 client 开始调用到 socket fd 返回第一个字节经过的时间</li>
<li><strong>step2</strong> 表示从 client 开始接受第一个字节，到接受整个请求所花费的时间</li>
</ul>
<ol>
<li>在 <strong>step1</strong> 中，client 遇到 socket timeout 会进行重试，直到到达了 ctx 设置的时间上限</li>
<li>在 <strong>step2</strong> 中，client 遇到 socket timeout ，大多数时候都是直接返回 timeout error, 只有 <strong>特别极端的案例</strong> ，才会进行重试。</li>
</ol>
<p><strong>特别极端的案例是什么:</strong></p>
<p>假设有这样的响应，</p>
<ol>
<li>socket fd 首先发会了 thrift message header,</li>
<li>正好发完 message header 之后, 网络阻塞了</li>
<li>此时 client 正在调用 <code>ReadFieldBegin</code> 函数读取参数结构体，它遇到 socket timeout error 就会进行重试</li>
</ol>
<p>在 golang server 中，响应是一起发送的，所以不存在 server 主动卡住的请求，TCP 发送字节的情况特别随机，几乎不可能存在正好发送完 message header 就卡住的情况(而且 message header 长度还是可变的)，所以可以认为这种特别极端的情况不存在。</p>
<h2 id="回到注意事项">回到注意事项</h2>
<p>了解完实现细节后，我们再来看文章开头提到的两个注意事项</p>
<ol>
<li>socket timeout 必须比 context timeout 小</li>
</ol>
<p>在上文的 <code>readAll</code> 函数中，当 socket timeout 触发时，会检查是否达到了 context timeout 的限制，如果我们设置了 <code>socket timeout</code> &gt; <code>context timeout</code>, 那么就会存在 <code>context timeout</code> 到了限制时间，但函数仍然阻塞在 <code>transport.Read</code> 中的情况</p>
<ol start="2">
<li>弱网环境中，socket timeout 不能设置的特别小</li>
</ol>
<p>在上一节的分析中，我们知道了在 <strong>step2</strong> 中遇到了 <code>socket timeout</code>时, 请求会直接失败，返回 <code>timeout error</code>。</p>
<p>那么在弱网环境中，如果我们将 <code>socket timeout</code> 设置的很小，但是 <code>context timeout</code> 很大，那么会遇到很多在 <strong>step2</strong> 中因为 <code>socket timeout</code> 导致的超时错误，而 <code>context timeout</code> 实际上还远远达不到。</p>
<ol start="3">
<li>遇到超时错误后，应该将连接关闭</li>
</ol>
<p>如果遇到超时错误了，client 会直接返回错误，但是过了一段时间 server 又将响应发回来了，后续的 <strong>新请求</strong> 就可能读到 <strong>旧响应</strong> 。</p>
<p>此时因为 thrift 请求和响应的 seq_id 或 method name 对不上，就会返回错误</p>
<pre tabindex="0"><code>{method_name}: out of order sequence response // seq id 对不上
{method_name}: wrong method name  // 方法名对不上
</code></pre><p>这部分检查代码在 <a href="https://github.com/apache/thrift/blob/v0.18.1/lib/go/thrift/client.go#L56-L66"><code>lib/go/thrift/client.go:56</code></a> 文件的 <code>func (p *TStandardClient) Recv</code> 函数中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TStandardClient</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Recv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">iprot</span> <span style="color:#000">TProtocol</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">seqId</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span> <span style="color:#000">TStruct</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rMethod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rTypeId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rSeqId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">iprot</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadMessageBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">rMethod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewTApplicationException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">WRONG_METHOD_NAME</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: wrong method name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">seqId</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">rSeqId</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewTApplicationException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BAD_SEQUENCE_ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: out of order sequence response&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b127652654fb8cc62d6983427adc109f">2 - Thrift 协议学习笔记</h1>
    
	<p>本文主要讲了 thrift 的协议格式</p>
<hr>
<p>Thrift 是一个集序列化和服务通信功能于一身的 RPC 框架，主要包含三大部分，代码生成，序列化框架，RPC 框架。</p>
<p>Thrift 支持多种序列化协议，主要有 Binary, Compact, JSON, 本文主要讲解了 Binary 和 Compact 序列化协议。</p>
<h1 id="thrift-请求响应模型">Thrift 请求响应模型</h1>
<p>Binary 协议和 Compact 协议都假定底层的 transport 层会提供一个允许双向通信的字节流信道(例如 TCP 套接字)。它们都使用了如下的通信模式:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-113200.png" alt=""></p>
<ol>
<li>Client 发送 Message 给 Server, Message 主要包括方法名，参数以及一些元信息</li>
<li>Client 将方法参数当作一个 Struct 发给 Server</li>
<li>Server 处理完后，发送 Message 给 Client。Message 主要包括方法名，消息类型和一些元信息</li>
<li>Server 发送 Struct 给 Client, 这个 Struct 包括响应或异常 body</li>
</ol>
<h2 id="binary-协议">Binary 协议</h2>
<h3 id="message-格式">Message 格式</h3>
<h4 id="编码格式">编码格式</h4>
<p>Binary 协议中, Message 的格式如下 (strict encoding)</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-121420.png" alt=""></p>
<table>
<thead>
<tr>
<th>字节索引</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>第1字节的第一位固定是1, 表示使用 strict encoding</td>
</tr>
<tr>
<td>1-2</td>
<td><code>vvv</code> 前两个字节的后15位表示版本号, 固定是 1 (二进制格式是 <code>000 0000 0000 0001</code>)</td>
</tr>
<tr>
<td>3</td>
<td><code>unused</code> 第三个字节 unused 表示它不使用</td>
</tr>
<tr>
<td>4</td>
<td><code>mmm</code> 第四个字节格式为 00000mmm，后三位表示消息的类型</td>
</tr>
<tr>
<td>4-8</td>
<td><code>name length</code> 4-8 字节存储方法名的长度，它是一个32位有符号整数，使用大端序存储，这意味着方法名最长是 2^31-1</td>
</tr>
<tr>
<td>8..</td>
<td><code>name</code> 8字节后存储变长的方法名字符串，它使用 utf-8 编码</td>
</tr>
<tr>
<td>&hellip;4-end</td>
<td><code>seq id</code> 最后四个字节存储序列号</td>
</tr>
</tbody>
</table>
<h4 id="消息类型">消息类型</h4>
<table>
<thead>
<tr>
<th>Value</th>
<th>Binary</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>001</td>
<td><code>Call</code>: thrift 调用</td>
</tr>
<tr>
<td>2</td>
<td>010</td>
<td><code>Reply</code>: thrift 响应</td>
</tr>
<tr>
<td>3</td>
<td>011</td>
<td><code>Exception</code>: thrift server 返回了异常</td>
</tr>
<tr>
<td>4</td>
<td>100</td>
<td><code>Oneway</code>: thrift oneway 调用</td>
</tr>
</tbody>
</table>
<h4 id="序列号">序列号</h4>
<p>序列号是有符号的四字节整数，在一个传输层的连接上所有未完成的请求必须有唯一的序列号，客户端用序列号来处理响应的失序到达，实现请求和响应的匹配。服务端不需要检查序列号，也不应该在实现中对序列号有任何的依赖，只需要在响应的时候将其原样返回。</p>
<h4 id="old-encoding">old encoding</h4>
<p>上述讲的 binary 协议中的 strict encoding, 在 thrift 早期版本中，使用的是 old encoding 编码方式。old encoding 的编码方式如下</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-123231.png" alt=""></p>
<p>它没有版本号等信息，直接传输了方法名，类型以及 seq id</p>
<p>因为 old encoding 中，<code>name length</code> 是使用32位有符号数存储的，因为 <code>name length</code> 不能为负数，所以 old encoding 的第一位始终是0 (<code>name length</code> 在最前面)。strict encoding 中，将第一位设置成了1, 以此来区分 old encoding 和 strict encoding。</p>
<h3 id="struct-格式">struct 格式</h3>
<p>Struct 类型由两部分组成: Field + StopField</p>
<pre tabindex="0"><code>Struct := Field + StopField
Field := Field Header + Field Value
Field Header := field id + field value
</code></pre><p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-130322.png" alt=""></p>
<p>StopField 长度一个字节，全都置0，表示 Struct 或 Request/Response Body 的结束</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-130230.png" alt=""></p>
<p>Normal Field 的格式如上图所示，字段说明如下</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>tttttttt</td>
<td>field 类型，一个8位的有符号整数</td>
</tr>
<tr>
<td>field id</td>
<td>16位的有符号整数，使用大端字节序存储</td>
</tr>
<tr>
<td>field value</td>
<td>编码后的 field value</td>
</tr>
</tbody>
</table>
<p>field 类型的定义表</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>field type number</th>
</tr>
</thead>
<tbody>
<tr>
<td>bool</td>
<td>2</td>
</tr>
<tr>
<td>byte</td>
<td>3</td>
</tr>
<tr>
<td>double</td>
<td>4</td>
</tr>
<tr>
<td>i16</td>
<td>6</td>
</tr>
<tr>
<td>i32</td>
<td>8</td>
</tr>
<tr>
<td>i64</td>
<td>10</td>
</tr>
<tr>
<td>string</td>
<td>11, used for binary and string fields</td>
</tr>
<tr>
<td>struct</td>
<td>12, used for struct and union fields</td>
</tr>
<tr>
<td>map</td>
<td>13</td>
</tr>
<tr>
<td>set</td>
<td>14</td>
</tr>
<tr>
<td>list</td>
<td>15</td>
</tr>
</tbody>
</table>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-130956.png" alt=""></p>
<p>上图是一个 thrift 请求的抓包，可以看到此请求的 struct 中，共有三个 Field，分别存储了 1, 0, 4 这三个 I32 整数。</p>
<h3 id="list-和-set-的格式">list 和 set 的格式</h3>
<p>list 和 set 类型使用的是相同的格式，如下图所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-145100.png" alt=""></p>
<ul>
<li>tttttttt 表示集合元素类型，被编码成了 i8</li>
<li>size 表示集合中元素的格式，被编码成了 i32 (32位有符号整数)，且只允许是正数</li>
<li>elements 表示元素</li>
</ul>
<p>集合中元素的类型和 struct 中 field-types 使用相同的定义。</p>
<p>可以配置 list/set 最大的长度，默认没有设置，即是 i32 的最大值，(2^31-1, 2147483647)</p>
<h3 id="binarystring-格式">binary/string 格式</h3>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-170954.png" alt=""></p>
<p>binary 类型的格式如上图所示，4个字节的长度 + values。长度是 32位的有符号整数，这意味着 binary 数据的最大长度是 2^32-1, 2147483647</p>
<p>string 类型被 encode 成 utf-8 编码，然后使用 binary 的格式传输。</p>
<h3 id="map-格式">map 格式</h3>
<p>map 的格式如下:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-145643.png" alt=""></p>
<ul>
<li>kkkkkkkk 表示 map 中 key 的元素类型，被编码成了 i8</li>
<li>vvvvvvvv 表示 map 中 value 的元素类型，被编码成了 i8</li>
<li>size 表示 map 的大小，被编码成了 i32，只允许是正数</li>
<li>key value pairs 表示被编码后的 key-value 对。</li>
</ul>
<p>可以配置 map 最大的长度，默认没有设置，即是 i32 的最大值，(2^31-1, 2147483647)</p>
<h3 id="request-格式">request 格式</h3>
<p>thrift Request 由两部分组成, Message + Data</p>
<ol>
<li>Message 的格式参考上文</li>
<li>Data 使用 struct 格式序列化的方法的参数</li>
</ol>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-150009.png" alt=""></p>
<p>上图是用 wireshark 抓到的 thrift 请求:</p>
<ol>
<li>它是一个 Call 消息，方法名是 <code>calculate</code>, seq id 是 0</li>
<li>它有两个参数，第一个参数是 i32 整数，第二个参数是一个结构体，这两个参数被用 struct 的方式序列化起来，变成了 Data</li>
</ol>
<h3 id="response-格式">response 格式</h3>
<p>thrift Response 由两部分组成，Message + Data</p>
<ol>
<li>Message 的格式参考上文</li>
<li>Data 是函数的返回值，它以 struct 的方式序列化，
<ul>
<li>返回值的 field id == 0 时，表示这是一个正常的响应</li>
<li>返回值的 field id == 1 时，表示这个响应是 server 抛出了一个 thrift idl 文件中定义的异常</li>
</ul>
</li>
</ol>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-151113.png" alt=""></p>
<p>上图抓到的 thrift 响应的包:</p>
<ul>
<li>Message 部分表示它是一个 Reply 类型的消息。</li>
<li>Data 部分，由于 field id == 1, 表示它返回了一个异常。</li>
<li>整个 Data 部分是一个 struct 格式的响应体，异常又是一个 struct 格式的数据</li>
<li>响应的异常包含了 i32 数字和 string 两个字段。</li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-151113.png" alt=""></p>
<h3 id="exception-格式">exception 格式</h3>
<p>thrift exception 响应表示 thrift server 出现了某种错误，无法正确地处理请求</p>
<p>它由两部分组成: Message + Exception</p>
<ol>
<li>Message 的格式参考上文</li>
<li>Exception 的 Data 也是按照 struct 格式来编码的</li>
</ol>
<p>下图是 thrift exception 响应抓取的包:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-173446.png" alt=""></p>
<ul>
<li><code>00 00 00 2e</code> 是 frame 的长度</li>
<li><code>80 01 ... 6b 00 00 00 00</code> 这是 Message 的定义</li>
<li><code>0b</code> 表示第一个 field 是一个 string</li>
<li><code>00 01</code> 表示 field id == 1</li>
<li><code>00 00 00 0e</code> 表示 string 的长度是 14</li>
<li><code>49 6e 74 65 72 6e 61 6c 20 65 72 72 6f 72</code> 表示 <code>Internal error</code> 这个字符串</li>
<li><code>08</code> 表示第二个 field 是一个 i32</li>
<li><code>00 02</code> 表示 field id == 2</li>
<li><code>00 00 00 06</code> 表示 i32 的 值是6</li>
<li><code>00</code> 表示 StopField，代表这个 Struct 结束了</li>
</ul>
<p>thrift exception 中数字的含义如下:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-173956.png" alt=""></p>
<h2 id="compact-协议">Compact 协议</h2>
<h3 id="var-int">var int</h3>
<p>Compact 协议中，使用 var int + zigzag int 的方式来将整数进行编码</p>
<ol>
<li>i32, i64 格式的整数被转换成 zigzag 格式的整数，这样所有整数都使用非负整数的格式存储</li>
<li>zigzag 整数被编码成了 var int 变长整数。i32 整数消耗 1-5 个字节，i64 整数消耗 1-10 个字节。</li>
</ol>
<ul>
<li>i16 首先被转换成 i32 之后，再进行 zigzag + var int 编码, i8 数字不会进行编码，直接进行传输。</li>
</ul>
<p>关于 zigzag 以及变长整数编码，可以参考我的另一篇文章: <a href="/2022/03/01/variant_zigzag/">ZigZag 变长整数编码</a></p>
<h3 id="message-如何编码">Message 如何编码</h3>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-125326.png" alt=""></p>
<p>Compact 协议中，Message 的编码格式如上图</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pppppppp</td>
<td>协议 ID, 固定是 0x82, 1000 0010</td>
</tr>
<tr>
<td>mmm</td>
<td>消息类型，和 binary 协议中的消息类型定义相同</td>
</tr>
<tr>
<td>vvvvv</td>
<td>协议版本，无符号5位整数，固定是 00001</td>
</tr>
<tr>
<td>seq id</td>
<td>序列号 ID, 一个32位有符号整数被编码成了 var int</td>
</tr>
<tr>
<td>name length</td>
<td>方法名长度，一个有符号32位整数被编码成了 var int (name length &gt;= 0)</td>
</tr>
<tr>
<td>name</td>
<td>方法名, utf-8 编码的字符串</td>
</tr>
</tbody>
</table>
<h2 id="framed-vs-unframed">framed vs unframed</h2>
<ul>
<li>
<p>unframed 会将数据直接写入到 socket</p>
</li>
<li>
<p>使用 framed 格式，client/server 先将 request/response 写入到一个 buffer 中。最后向 socket 写入时，先写入一个四字节的 request/response 长度，再写入 request/response。</p>
</li>
<li>
<p>framed 格式下，请求的最大长度是 16384000 (16M)</p>
</li>
<li>
<p>thrift 引入 framed 格式的目的是为了方便异步处理器的实现。</p>
</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://andrewpqc.github.io/2019/02/24/thrift/">Thrift序列化协议浅析</a></li>
<li><a href="https://erikvanoosten.github.io/thrift-missing-specification/">Thrift specification - Remote Procedure Call</a></li>
<li><a href="https://www.bwangel.me/2022/03/01/variant_zigzag/">ZigZag 变长整数编码</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1bb16dc0ca8a634867ed72c7e903ba28">3 - Thrft</h1>
    
	<h2 id="thrift-概念">thrift 概念</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-05-27-060022.png" alt=""></p>
<h2 id="thrift-架构">thrift 架构</h2>
<p>Thrift 的架构图如下</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-12-17-100303.png" alt=""></p>
<p>Transport 层位于最底部，用户传输字节数据。</p>
<p>Transport 层提供的接口如下:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-12-17-100415.png" alt=""></p>
<p>Transport 层可以由多个 TTransport 类组合起来，每个 TTransport 提供不同的功能。处于 TTransport 组合层次最下方，和设备(网络，磁盘，内存)直接打交道的 TTransport 类称为 <strong>Endpoint transports</strong>。例如 <code>TSocket</code>，它使用 Socket API 在 TCP/IP 网络上传输数据。</p>
<p><code>TFramedTransport</code> 有两个作用:</p>
<ol>
<li>分帧，它在每个消息的头部加了四字节的长度，让接受者能够准确地得知消息的大小，并申请合适的 buffer</li>
<li>缓存。当 <code>flush</code> 方法调用的时候，缓存的数据才会写入下一层 Transport</li>
</ol>
<p>当不需要分帧，仅需要缓存的时候，可以使用 <code>TBufferedTransport</code>。某些语言在 Endpoint Transport 中內建了缓存机制，就没有提供 <code>TBufferedTransport</code> 类。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://livebook.manning.com/book/programmers-guide-to-apache-thrift/chapter-2/18">Chapter 2. Apache Thrift architecture</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d3ce439f30c5ecaccd3e7225d6be37c5">4 - 翻译《Chapter 1. Introduction to Apache Thrift》</h1>
    
	<blockquote>
<ul>
<li>原文地址: <a href="https://livebook.manning.com/book/programmers-guide-to-apache-thrift/chapter-1/">https://livebook.manning.com/book/programmers-guide-to-apache-thrift/chapter-1/</a></li>
</ul>
</blockquote>
<hr>
<h2 id="12-与apache-thrift的应用集成">1.2. 与Apache Thrift的应用集成</h2>
<p>无论你的应用程序是否使用多平台和语言，它的操作很可能基于网络和时间跨越多个进程。有时，这些进程需要通过磁盘上的文件，内存中的缓冲区，或者网络进行通信。和 IPC (Interprocess communication) 相关的两个核心概念是:</p>
<ol>
<li>类型序列化</li>
<li>服务实现</li>
</ol>
<p>让我们依次来考虑这两个问题。</p>
<h3 id="121-类型序列化">1.2.1 类型序列化</h3>
<p>序列化是任何跨平台/语言通信的基本功能。例如，想象一下一个音乐行业应用程序，使用 NATS 作为消息系统，在进程之间移动歌曲数据。使用 NATS，该团队可以在他们用 Java 或 Python 编写的远程进程之间快速发送/接收消息。问题是，当歌曲信息在进程之间传递时，程序能读懂另一个进程发送的信息吗？Python 对象和 Java 对象在内存中的表示方式不同。如果 Python 进程发送音乐轨道数据的原始内存信息，就会出现问题。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-12-17-145118.png" alt=""></p>
<p>为了解决这个问题，我们需要在信息传输平台上创建一个数据序列化层。有人可能会问，为什么不用 JSON 的形式来回发送一切呢？使用标准格式(例如 JSON) 可能是解决方案的一部分; 然而，我们仍必须回答这样的问题：</p>
<p>当发送多字段消息时，数据字段如何排序？ 当字段缺失时，会发生什么？一个不直接支持某种数据类型的语言在接收该数据类型的时，会做些什么？这些以及其他的问题，JSON, YAML 或 XML 等数据布局规范都无法解决。对于同一个数据集，不同语言经常产生不同但合法的格式。</p>
<ul>
<li><strong>IDL and Types</strong></li>
</ul>
<p>Apache Thrift提供了一个模块化的序列化框架来解决这些问题。
通过Apache Thrift，开发者在接口定义语言（IDL）中定义抽象数据类型。 然后这个IDL可以被编译成任何支持的语言的源代码。 生成的代码为用户定义的所有类型提供完整的序列化和反序列化逻辑。
Apache Thrift确保任何语言编写的类型都可以被任何其他语言读取。下面的代码显示了一个假设的音乐应用程序的Apache Thrift IDL 类型定义。</p>
<pre tabindex="0"><code>namespace * music

enum PerfRightsOrg {
    ASCAP = 1
    BMI = 2
    SESAC = 3
    Other = 4
}

typedef double Minutes

struct MusicTrack {
    1: string title
    2: string artist
    3: string publisher
    4: string composer
    5: Minutes duration
    6: PerfRightsOrg pro
}
</code></pre><p>有人抱怨说创建 IDL 是一个额外的步骤，减缓了开发进程。我发现恰恰相反。IDL 强迫你独立地小心考虑你的接口设计，而无需关心嘈杂的实现代码。这可能是你花在系统设计上最终要的时间。IDL 也是轻量级，易于修改和实验，并经常作为业务方面的通信工具而发挥作用。</p>
<p>用户可能会说无模式的系统更加灵活，而 IDL 很坚硬。事实上是，无论你是否记录了你的模式，当你读取和解释数据的时候，你都会需要一个模式。隐含模式会是非常危险的线上错误的来源，而且会给想要操作数据或扩展系统的人造成负担。</p>
<p>如果，除了读取和写入的代码，除此之外你对你读写的数据没有任何定义。当你想扩展系统的时候进展就会很缓慢。整个系统有多少代码依赖于这样的隐含模式？你如何改变这样一个东西？</p>
<p>许多无模式的 NoSQL 系统的流行，为 IDL 创造了另外一个角色。你现在可以在一个地方记录你的类型，并在使用消息系统和 NoSQL 存储系统(Redis, MongoDB 或其他 NoSQL 系统)的服务调用中使用这些类型。</p>
<p>有几个系统反其道而行之，从一个给定的编码方案中生成它们的模式。注释驱动的系统，如Java的JAX-RS，就以这种方式工作。这种方法很容易让实现细节影响接口定义，使可移植性和清晰性受到限制。一般来说，修改实现代码要比修改IDL的工作量大得多。另外，你不能保证另一个供应商的代码生成器会从一个外部模式中创建兼容的代码。当多个供应商参与到一个通信解决方案中时，这就是一个问题。</p>
<p>Apache Thrift通过提供唯一定义 Schema 来源，即 IDL ，避免了许多这些问题。Apache Thrift提供了独立于供应商的支持，在广泛的编程语言中使用单一的IDL，并且Apache Thrift的跨语言测试套装随着框架的发展不断地验证互操作性。</p>
<ul>
<li><strong>Interface evolution (接口演变)</strong></li>
</ul>
<p>IDL 创建了一个各方都可以依赖的契约，代码生成器可以用来创建工作的序列化操作，确保契约得到遵守。然而，IDL模式不需要很脆(brittle)。Apache Thrift IDL支持一系列的接口演化功能，如果使用得当，允许添加和删除字段，改变类型，等等。</p>
<p>对接口进化的支持大大简化了持续的软件维护和扩展的任务。现代工程意识，如微服务、持续集成（CI）和持续交付（CD）要求系统支持增量改进，而不影响平台的其他部分。那些不提供接口进化形式的工具，在改变时往往会 &ldquo;破坏世界&rdquo;。在这样的系统中，改变接口意味着所有使用该接口的客户端和服务器必须重写或重新编译，然后在大爆炸中重新部署。</p>
<p>Apache Thrift的接口进化功能允许多个接口版本在一个操作环境中无缝共存。这使得增量更新成为可能，使CI/CD管道成为可能，并使各个敏捷团队能够以他们自己的节奏交付商业价值。</p>
<ul>
<li><strong>Modular serialization</strong></li>
</ul>
<p>Apache Thrift提供了可插拔的序列化器，被称为协议，允许你使用几种序列化格式中的任何一种进行数据交换，包括 Binary (速度快)，compact(体积小)，以及JSON(可读性好)。即使你改变了序列化协议，同样的契约（IDL）也可以保持原样。这种模块化的方法也允许添加自定义的序列化协议。由于Apache Thrift是社区管理和开源的，你可以很容易地改变或增强功能，并在需要时向上游推送（Apache Thrift项目始终欢迎补丁）。</p>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-end text-xs-center order-sm-3">
        
        
        
<ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/bwangelme/" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2">
        <span>&copy; 2023 力行近乎仁，好问近乎智，知耻近乎勇 </span>
        <span class="ms-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></span>
        
      </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
      integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ==" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
        integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g=="
        crossorigin="anonymous">
</script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
       integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin="anonymous"
       onload='renderMathInElement(document.body, null);'>
</script>
<script src="/647/js/main.min.4f6bdd3cd8cde411a9b8cc8c9f435ab27b7a07d49198bf6bc750cdcd26e6e429.js" integrity="sha256-T2vdPNjN5BGpuMyMn0Nasnt6B9SRmL9rx1DNzSbm5Ck=" crossorigin="anonymous"></script>
<script src='/647/js/prism.js'></script>
<script src='/647/js/tabpane-persist.js'></script>

  </body>
</html>
