<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.115.2">
<link rel="canonical" type="text/html" href="https://bwangelme.github.io/647/docs/redis/">
<link rel="alternate" type="application/rss&#43;xml" href="https://bwangelme.github.io/647/docs/redis/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/647/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/647/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/647/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/647/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/647/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/647/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/647/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/647/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/647/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/647/favicons/android-192x192.png" sizes="192x192">

<title>Redis | 647 Universe</title>
<meta name="description" content="宇宙很大，生活更大，也许以后还有缘相见">
<meta property="og:title" content="Redis" />
<meta property="og:description" content="宇宙很大，生活更大，也许以后还有缘相见" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://bwangelme.github.io/647/docs/redis/" /><meta property="og:site_name" content="647号宇宙" />
<meta itemprop="name" content="Redis">
<meta itemprop="description" content="宇宙很大，生活更大，也许以后还有缘相见"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Redis"/>
<meta name="twitter:description" content="宇宙很大，生活更大，也许以后还有缘相见"/>




<link rel="preload" href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" as="style">
<link href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/647/css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/647/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">647 Universe</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/647/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/647/docs/redis/"></a>.
</p>
</div>



<h1 class="title">Redis</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-452fe98fe10bf583ed0509083a6fa631">Redis 备份恢复的正确步骤</a></li>


    
  
    
    
	
<li>2: <a href="#pg-9f184c796063902888d119a9e9dbf239">Redis 主从同步细节</a></li>


    
  
    
    
	
<li>3: <a href="#pg-f69785f60caf73840045abeb86206c30">Redis 备份机制</a></li>


    
  
    
    
	
<li>4: <a href="#pg-0bff432c35e390c24fb8a4000eb1827a">Redis 集群简介</a></li>


    
  
    
    
	
<li>5: <a href="#pg-5e80ba3bff85aef5c731bcf3ecb0922c">Redis 源码阅读之 dict </a></li>


    
  
    
    
	
<li>6: <a href="#pg-24908c465f52816f8bd5bc366e5a5645">Redis Sort 命令简介</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-452fe98fe10bf583ed0509083a6fa631">1 - Redis 备份恢复的正确步骤</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<ol start="0">
<li>清空数据目录下的 dump.rdb 和 appendonly.aof 文件</li>
<li>将备份的 rdb 文件拷贝到 redis 的数据目录下 (<code>dir</code>选项配置了数据目录)</li>
<li>修改配置文件，设置 <code>appendonly no</code></li>
<li>启动 redis-server</li>
<li>通过 redis-cli 开启 appendonly 备份: <code>CONFIG SET appendonly yes</code></li>
<li>同时修改配置文件，开启 aof 备份</li>
</ol>
<h2 id="注意">注意</h2>
<p>必须要关闭 appendonly 后，rdb 备份才能正确回复，否则恢复出来的数据是空的</p>
<h2 id="原因">原因</h2>
<p>redis server 启动后会生成 appendonly.aof 文件，在 dump.rdb 和 appendonly.aof 文件同时存在的时候，会优先恢复 appendonly.aof 文件，由于 appendonly.aof 是空的，redis server 中的数据也会变成空的。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9f184c796063902888d119a9e9dbf239">2 - Redis 主从同步细节</h1>
    
	<blockquote>
<p>介绍了 Redis 的主从同步流程及一些配置选项</p>
</blockquote>
<hr>
<h2 id="完整的复制流程">完整的复制流程</h2>
<ol>
<li>slave 启动，获取 master 节点的信息，包括 (master run_id)</li>
<li>如果 slave 中可以找到此 master 的数据，发送 <code>PSYNC {master run id} {slave offset}</code> 指令给 master，请求开始部分复制。</li>
<li>如果 slave 找不到 master 的数据，发送 <code>PSYNC ? -1</code> 指令给 master，请求全量复制。</li>
<li>口令认证，如果 master 设置了 <code>requirepass</code>，slave 节点必须发送 <code>masterauth</code> 设置的口令去认证</li>
<li>master node 执行一次全量复制/部分复制，将数据同步到 slave 上。</li>
<li>master node 后续持续将写命令，异步地发送给 slave，同时会将命令写入到先进先出的队列 backlog 中</li>
</ol>
<p>主从复制的流程图如下</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-10-22-143417.png" alt=""></p>
<h2 id="复制过程中的参数说明">复制过程中的参数说明</h2>
<ul>
<li>offset (复制偏移量)</li>
</ul>
<p>master 和  slave 都会维护一个累加的 offset，master 还会维护每个 slave 的offset，用于沟通数据的差异。</p>
<p><code>role</code>命令可以查看复制偏移量</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># master role</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; role
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;master&#34;</span>  <span style="color:#8f5902;font-style:italic"># 服务器的角色</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">98</span>  <span style="color:#8f5902;font-style:italic"># master 的复制偏移量</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> 1<span style="color:#ce5c00;font-weight:bold">)</span> 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span>  <span style="color:#8f5902;font-style:italic"># slave host</span>
</span></span><span style="display:flex;"><span>      2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;6380&#34;</span>   <span style="color:#8f5902;font-style:italic"># slave port</span>
</span></span><span style="display:flex;"><span>      3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;98&#34;</span>     <span style="color:#8f5902;font-style:italic"># slave 的复制偏移量</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave role</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6380&gt; role
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;slave&#34;</span>  <span style="color:#8f5902;font-style:italic"># 服务器的角色</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;localhost&#34;</span>  <span style="color:#8f5902;font-style:italic"># master host</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">6379</span>  <span style="color:#8f5902;font-style:italic"># master port</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;connected&#34;</span>  <span style="color:#8f5902;font-style:italic"># 和 master 的连接状态</span>
</span></span><span style="display:flex;"><span>5<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">112</span>  <span style="color:#8f5902;font-style:italic"># slave 的复制偏移量</span>
</span></span></code></pre></div><p>连接状态有以下几种值:</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>&ldquo;none&rdquo;</td>
<td>主从服务器尚未建立连接</td>
</tr>
<tr>
<td>&ldquo;connect&rdquo;</td>
<td>主从服务器正在握手。</td>
</tr>
<tr>
<td>&ldquo;connecting&rdquo;</td>
<td>主从服务器成功建立了连接。</td>
</tr>
<tr>
<td>&ldquo;sync&rdquo;</td>
<td>主从服务器正在进行数据同步。</td>
</tr>
<tr>
<td>&ldquo;connected&rdquo;</td>
<td>主从服务器已经进入在线更新状态。</td>
</tr>
<tr>
<td>&ldquo;unknown&rdquo;</td>
<td>主从服务器连接状态未知。</td>
</tr>
</tbody>
</table>
<ul>
<li>run id</li>
</ul>
<p>master run id 发生变化时， slave 会重新做全量复制</p>
<p>使用 <code>info server</code> 可以查看当前 Redis Server 的 run id</p>
<h3 id="full-resynchronization-全量复制">Full Resynchronization (全量复制)</h3>
<ol>
<li>master 执行 bgsave，用子进程生成 rdb 快照文件</li>
<li>master 生成快照文件的同时会将随后的操作指令写在内存缓存中</li>
<li>master 将 rdb 文件发送给 slave node，如果发送时间超过 <code>repl-timeout</code> （默认是 60s），那么 slave node 就会认为复制失败，可以适当调大这个参数.</li>
<li><code>client-output-buffer-limit slave 256M 64M 60</code>，如果在复制过程中，内存缓存区持续消耗超过 64M，或一次性超过 256M，那么停止复制，复制失败。</li>
<li>slave 将 rdb 文件落盘</li>
<li>slave 从 rdb 文件恢复数据，恢复的同时基于旧数据 serve</li>
<li>如果 slave 开启了 aof 备份，那么恢复成功后会立即执行 BGREWRITEAOF，重写 AOF</li>
<li>master 在 slave 恢复成功后将内存缓存的操作指令发送给 slave</li>
</ol>
<blockquote>
<p><strong>在数据同步时复用 rdb 文件</strong></p>
<ol>
<li>如果 master 在收到 replicaof 指令之前已经执行过一次 bgsave 命令，且数据库在执行 bgsave 之后没有任何变化，那么 master 将会直接向 slave 发送已经生成的 rdb 文件</li>
<li>如果 master 在生成 rdb 文件期间，又有多个 slave 请求同步数据，那么 master 会把请求同步的 slave 全部放到队列中，等 rdb 文件生成后，一起发送给队列中的所有 slave</li>
</ol>
</blockquote>
<h2 id="在线更新">在线更新</h2>
<p>master 和 slave 执行完全量复制后，</p>
<ol>
<li>master 会将收到的写指令发送给 slave 执行，让两边数据同步</li>
<li>master 对每个 slave 都会维护一个先进先出的队列，存储 slave 收到的写指令。可以通过 <code>repl-backlog-size</code> 设置这个队列的大小</li>
</ol>
<h2 id="部分复制-partial-resynchronization">部分复制 (partial resynchronization)</h2>
<ol start="0">
<li>在 redis 2.8 之前，如果 slave 断开连接后又重新建立连接，slave 会请求重新执行一次全量同步，这样非常浪费资源</li>
<li>redis 2.8 之后，添加了部分复制的功能</li>
<li>第一次全量复制完成后，master 每次向 slave 发送的指令都会存储到 backlog 中</li>
<li>如果 slave 因为网络原因短暂地断开了连接， slave 重新连接后会发送 replica offset 到 master 中</li>
<li>master 如果在 backlog 中找到了 replica offset，master 会将 backlog 中存储的剩余数据发送过来。</li>
<li>如果找不到，master 会开始进行全量复制</li>
</ol>
<blockquote>
<p>backlog 的容量越大，master 所能容忍的 slave 断线时间也就越长，可以通过 <code>repl-backlog-size</code> 选项更改 backlog 的大小。</p>
</blockquote>
<h2 id="无盘化复制">无盘化复制</h2>
<p>两个相关选项:</p>
<ul>
<li>repl-diskless-sync</li>
</ul>
<p>开启此选项后，rdb 文件在 master 上不会落盘，会直接发送给 slave，slave 上还是会进行落盘，redis 目前无法做到完全不依靠硬盘实现主从复制。</p>
<ul>
<li>repl-diskless-sync-delay</li>
</ul>
<p>开启无盘化复制后，新的 Slave 无法复用之前已经开始的复制任务，只能等待新的复制任务。<code>repl-diskless-sync-delay</code> 设置复制任务在收到 Slave 的请求多久后开始，以等待更多的 Slave 连接，一起发送 rdb 数据。</p>
<h2 id="降低数据不一致出现的概率">降低数据不一致出现的概率</h2>
<h3 id="因-master-挂掉出现数据不一致">因 master 挂掉出现数据不一致</h3>
<ol>
<li>master 将数据同步到 slave 是异步进行的，如果 master 还有部分数据未同步，就挂掉了。哨兵发现 master 不正常，及时切换了 master，但旧 master 中未同步的数据就会丢失掉了。</li>
<li>设置 <code>min-slaves-max-lag 10</code> 选项，表示如果超过10秒 slave 没有和 master 通信过，master 就认为 slave 和自己的数据差别太大，不再接收写操作。这样 master 挂掉后可以少丢失一些数据。</li>
</ol>
<h3 id="因集群脑裂出现数据不一致">因集群脑裂出现数据不一致</h3>
<ol>
<li>因为网络原因，集群短暂地分裂成两个，两个 master 都接收数据。网络恢复后，节点少的 master 会重新变成 slave，此时这个 master 上写的数据就会丢失。</li>
<li>设置 <code>min-slaves-to-write 3</code> 选项，表示如果 slave 个数小于3，master 就不再接收写操作，小集群的 master 不写数据，集群恢复后，也不会造成数据丢失。</li>
</ol>
<h2 id="过期-key-处理">过期 key 处理</h2>
<p>如果设置了 <code>slave-read-only=yes</code>， Slave 不会主动过期 key，master 在将 key 过期后，会发送 DEL 指令给 Slave</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f69785f60caf73840045abeb86206c30">3 - Redis 备份机制</h1>
    
	<hr>
<h2 id="redis-的-aof-和-rdb-备份机制">Redis 的 AOF 和 RDB 备份机制</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-02-19-224253.png" alt="RDB 和 AOF 介绍"></p>
<p>RDB 比 AOF 恢复要快</p>
<ul>
<li>AOF 存储的是写入指令，它恢复是重放写入指令。</li>
<li>RDB 恢复时是将文件直接写入内存，恢复速度更快。</li>
</ul>
<p>RDB 是定时备份，AOF 的每条操作都会写入磁盘(中间有 linux 系统缓存, fsync 会同步系统缓存到磁盘中)，故 RDB 的写入速度要比 AOF 要高。</p>
<p>如果 AOF 和 RDB 备份都存在，那么 redis 优先会从 AOF 恢复数据文件。</p>
<h3 id="rdb-备份">RDB 备份</h3>
<p>配置文件中设置:</p>
<p>每条 save 是一个检查点，每隔 <code>&lt;seconds&gt;</code> 秒，检查是否有至少 <code>&lt;changes&gt;</code> 个key 发生了变化，如果有的话就执行一次备份。</p>
<pre tabindex="0"><code># save &lt;seconds&gt; &lt;changes&gt;
save 900 1
save 300 10
save 60 10000
</code></pre><p>RDB 持久化的工作流程:</p>
<ol>
<li>redis 根据配置的检查点，尝试去生成 rdb 快照文件</li>
<li>redis fork 一个子进程出来</li>
<li>子进程尝试将数据 dump 到 rdb 快照文件中</li>
<li>完成 rdb 文件的 dump 后，就用新文件替换掉之前的旧文件</li>
</ol>
<p>如果是通过 <code>redis-cli shutdown</code> 的方式来关闭 redis server 的话，redis server 会在关闭之前会同步一次 rdb 文件。</p>
<h3 id="aof-备份">AOF 备份</h3>
<p>配置:</p>
<p><code>appendfsync</code> 表示多长时间执行一次 <code>fsync</code> 系统调用，将 os cache 数据写入到磁盘中，默认是 everysec，每秒写一次。</p>
<p>AOF ReWrite 过程:</p>
<ol>
<li>redis fork 一个子进程</li>
<li>子进程基于当前内存中的数据，构建日志，开始往一个新的临时的 aof 文件中写入日志</li>
<li>redis 主进程，接收到 client 端的写操作之后，
<ol>
<li>往旧的 aof 文件中写日志</li>
<li>开辟一个新的内存区域，在其中写入日志</li>
</ol>
</li>
<li>子进程写完新的日志文件之后，redis 主进程会将内存区域中的新日志再次追加到新的 aof 文件之中</li>
<li>用新的日志文件，替换掉旧的日志文件</li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0bff432c35e390c24fb8a4000eb1827a">4 - Redis 集群简介</h1>
    
	<hr>
<h2 id="为什么要有-redis-集群">为什么要有 Redis 集群</h2>
<p>redis 单机最多只能支持 1万 到 几万不等的 QPS (根据操作的不同 serve 能力也不同)。如果我们想要支撑更高的 QPS，就需要配置 Redis 集群。</p>
<h2 id="redis-集群是为了解决什么问题">Redis 集群是为了解决什么问题</h2>
<p>Redis 集群可以通过读写分离的设置，支持大规模读多写少的操作场景( QPS 达到百万级)。写多的操作场景单纯配置 Redis 集群是无法支持的，我们还需要更改客户端实现，像 kafka 客户端一样通过队列合并写入操作。</p>
<h2 id="redis-replication-是如何工作的">Redis Replication 是如何工作的</h2>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvnd81kfq3j60er0dhjs002.jpg" alt=""></p>
<p>Redis 集群的架构图如上所示。</p>
<ul>
<li>Client 将数据写入到 Master 节点后就立刻返回了，Slave 节点从 Master 同步数据过来，Client 不会确认数据是否同步到了 Slave 节点中。</li>
<li>2.8 以后， Slave 会周期性地确认自己复制的数据量</li>
<li>Slave 节点也可以连接其他 Slave 节点</li>
<li>Slave 节点做复制的时候，不会阻塞 Master 节点，也不会阻塞自己，它会用旧的数据集 Serve，当复制完成时，会删除旧的数据集，加载新的数据集，此时会短暂地停止对外服务。(时间在毫秒到秒之间)</li>
<li>Slave 节点主要应用在读多写少场景下的读写分离操作上，扩容 Slave，可以提高集群的 <strong>读</strong> 吞吐量。</li>
</ul>
<h2 id="redis-集群数据备份的配置">Redis 集群数据备份的配置</h2>
<p>Redis 集群做持久化的时候，需要配置 Master 节点的持久化。因为以下原因：</p>
<p>假设我们配置了 Slave 节点的持久化，而没有配置 Master 节点。当 Master 节点宕机重启后，它会直接认为自己的数据是空的，同时将这个状态同步到 Slave，从而导致集群的数据消失。</p>
<p>尽管 Master 挂掉以后，Sentinel 会切换 Master，但这有时间成本，如果在 Sentinel 发现之前 Master 就重启了，一样会造成数据丢失。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e80ba3bff85aef5c731bcf3ecb0922c">5 - Redis 源码阅读之 dict </h1>
    
	<p>本文主要介绍了 Redis 的基础数据结构 dict 的实现，并描述了其渐进式 rehash 的操作</p>
<p><strong>注意</strong>: 本文基于 Redis 3.0.0 的代码进行分析的</p>
<h2 id="dict-介绍">dict 介绍</h2>
<p>dict 又称符号表(symbol table)，关联数组(associative array)或映射(map)，是一种用于保存键值对的抽象数据结构。</p>
<p>Redis 实现使用的C语言并没有内置 dict 这种数据类型，所以 Redis 实现了自己的 dict。dict 在 Redis 中有广泛的应用，Redis 数据库的底层就是使用字典来实现的，也就是说对数据库的增，删，改，查都是建立在字典之上的。同时，字典也是<code>hash</code>和<code>sorted set</code>等数据结构的底层实现之一。</p>
<h2 id="dict-的实现">dict 的实现</h2>
<p>在 Redis 中，dict 的代码存放在<code>src/dict.c</code>和<code>src/dict.h</code>两个文件中。在<code>src/dict.h</code>中定义了 dict 所用到的结构体，一共有四个:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 哈希表项
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictEntry</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">uint64_t</span> <span style="color:#000">u64</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#000">s64</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictEntry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">next</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// 哈希表中是通过单链表解决键索引冲突的，next用来指向同一个键索引下的下一个元素
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictEntry</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 这里的思想类似于Go，使用函数来定义字典类型(接口)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictType</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">hashFunction</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keyDup</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">valDup</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keyCompare</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keyDestructor</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">valDestructor</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictType</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 哈希表结构体，每个字典都有两个哈希表，其中多的一个用来做渐进式 rehash */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictht</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dictEntry</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">// 哈希表项组成的数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">// 当前哈希表的大小
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">sizemask</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 哈希表大小的掩码，总是等于size - 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">used</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">// 哈希表中哈希表项的数目
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictht</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 字典的定义 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dict</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dictType</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 字典的类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 字典私有数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">dictht</span> <span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>    <span style="color:#8f5902;font-style:italic">// 字典中的哈希表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rehashidx</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// rehashidx == -1 表示当前字典没有做 rehash，否则表示当前字典正在进行 rehash 操作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iterators</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// 安全迭代器的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dict</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 字典迭代器用来获取字典中所有的项，其中迭代器可以分为安全迭代器和非安全迭代器两种
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 安全迭代器表示在迭代过程中可以调用字典的 dictAdd(), dictFind() 等接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 非安全迭代器在迭代过程中只能调用 dictNext() 接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictIterator</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dict</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">// 迭代器所关联的字典
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">// 当前迭代器在字典中迭代的索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">safe</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">// 哈希表的索引，当前迭代器是否是安全迭代器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">dictEntry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">entry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nextEntry</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// 当前迭代器所指向的哈希表项和下一个哈希表项
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">/* unsafe iterator fingerprint for misuse detection. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">fingerprint</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 字典的指纹，非安全迭代器中用于鉴别字典是否被修改过
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictIterator</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>他们之间的关系如图1所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-10-054715.png" alt="图1"></p>
<p><strong>图1</strong></p>
<p>当我们向字典中存储键值对(k, v)时，字典通过一定的算法计算出k的索引值，它的计算方法如下:</p>
<pre tabindex="0"><code># 先根据哈希算法计算出键k的哈希值，哈希值为unsigned int 类型
hash = d-&gt;type-&gt;hashFunction(k)
# 然后再将哈希值和哈希表的sizemask按位与，获得键k在哈希表中的索引
idx = hash &amp; d-&gt;ht[table].sizemask
</code></pre><p>最后按照计算出来的索引值将键值对存储到字典中的哈希表中。</p>
<h2 id="dict-的哈希算法">dict 的哈希算法</h2>
<p>dict 按照使用方式的不同，所采取的哈希算法也不同。Redis目前共使用两种不同的哈希算法：</p>
<ol>
<li>MurmurHash2 32 bit 算法：这种算法的分布率和速度都非常好， 具体信息请参考 MurmurHash 的主页： <a href="http://code.google.com/p/smhasher/">http://code.google.com/p/smhasher/</a> 。</li>
<li>基于 djb 算法实现的一个大小写无关散列算法：具体信息请参考 <a href="http://www.cse.yorku.ca/~oz/hash.html">http://www.cse.yorku.ca/~oz/hash.html</a> 。</li>
</ol>
<ul>
<li>dict 在命令表以及 Lua 脚本缓存中时，使用了算法2</li>
<li>dict 在数据库，集群，哈希键和阻塞操作等功能中都使用到了算法1</li>
</ul>
<h2 id="dict-解决键冲突的方案">dict 解决键冲突的方案</h2>
<p>根据前面的内容所知，向dict中添加键值对时，dict根据键计算出来的索引值将键值对存储到哈希表中。由于哈希表的大小是有限的，所以可能会出现两个键的索引值相同的情况，这种情况也称作键冲突。</p>
<p>当出现键冲突的时候，dict会将两个键值对存放在同一个哈希表的同一个索引下，它们通过单链表的形式组合起来，如图2所示：</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-13-155621.jpg" alt="图2"></p>
<p><strong>图2</strong></p>
<p>其中k1和k2计算出来的索引值是相同的，他们被存放到哈希表的同一个索引下，然后通过单链表的形式组合起来。</p>
<p>在 <code>src/dict.c</code>的<code>dictEntry *dictAddRaw(dict *d, void *key)</code>函数中，我们可以看到向单链表中添加元素的过程</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 哈希表通过单链表来解决键冲突，下面的代码向单链表中添加了哈希表节点 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000">entry</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zmalloc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">entry</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000">entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ht</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ht</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">entry</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ht</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">used</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>申请一个哈希表项之后，将它的地址存放在哈希表中，同时也使哈希表中原来存在的节点变成它的next节点，即新增元素在单链表的头部。</p>
<h2 id="渐进式-rehash">渐进式 rehash</h2>
<p>每个dict都有一个负载因子，计算方式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">load_factor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">used</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">size</span>
</span></span></code></pre></div><p>当 dict 的负载因子过大或过小的时候，Redis 需要为这个 dict 扩展或者收缩哈希表的大小，这个过程叫做 rehash。上文中我们提到每个 dict 都有两个哈希表, <code>ht0</code>和<code>ht1</code>，在这里它们就发挥作用了。rehash 的具体操作如下:</p>
<ol>
<li>
<p>设置<code>ht1</code>的size，扩展过程中size为大于<code>ht0.size</code>的最小2次幂，收缩过程中size为大于<code>ht0.used</code>的最小2次幂</p>
</li>
<li>
<p>将 dict.rehashidx 设置为0</p>
</li>
<li>
<p>在增删改查的过程中，检查 dict.rehashidx 是否不等于 -1，如果是，那么就执行<code>_dictRehashStep</code>操作，<code>_dictRehashStep</code>的操作如下:</p>
<ul>
<li>如果当前字典上的没有安全迭代器，执行<code>dictRehash</code>操作</li>
<li><code>dictRehash</code>操作就是从<code>ht0</code>中取出值，重新计算哈希值，然后放到<code>ht1</code>中，并将<code>ht0.used</code>减少。将<code>dict.rehashidx</code>的索引加1。由于在这个过程中重新计算了 key 的哈希值，所以这个过程称为 <strong>rehash</strong></li>
<li>如果<code>ht0</code>中的所有元素都复制到了<code>ht1</code>中后，Redis 会交换<code>ht1</code>和<code>ht0</code>的地址，然后将<code>ht1</code>置为空表(即存在dictht这个结构体变量，但是里面的dictEntry指针为空，没有任何哈希表项)，同时将<code>dict.rehashidx</code>置为 -1。</li>
<li>同时<code>dictRehash</code>还有一个限制，每次 rehash 的时候存在一个 <code>empty_visits</code> 限制(empty_visits = 10 * n，n是本次<code>dictRehash</code>操作要 rehash 哈希表项的数量)。如果访问到的空的哈希表项的次数超过了<code>empty_visits</code>，本次 rehash 操作就结束了。</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>由于 rehash 操作不是一次性做完的，而是在字典的操作中一点一点做的，所以这个过程称作__渐进式rehash__</p>
</li>
<li>
<p>因为在字典的增删改查操作中执行了 rehash 操作，所以这些操作的行为也会受到影响</p>
<ul>
<li>在<code>dictAdd</code>操作中，如果当前字典正在进行 rehash，那么新加的值都会加入到<code>ht1</code>中，这样保证<code>ht0</code>只会减少，不会增加，最终<code>ht0</code>会变成空表</li>
<li>在<code>dictFind</code>操作中，会在<code>ht0</code>和<code>ht1</code>两个哈希表中查询对应的键</li>
<li>在<code>dictDelete</code>操作中也回在<code>ht0</code>和<code>ht1</code>中查找对应的键</li>
<li><code>dictReplace</code>操作调用的是<code>dictFind</code>方法查找对应的键</li>
</ul>
</li>
<li>
<p>在执行 BGSAVE 和 BGREWRITEAOF 命令时，Redis 会提高字典的负载因子。因为在调用这两个命令时，Redis 会为当前进程产生子进程，而很多操作系统采用了写时复制的策略，如果不执行 rehash 操作，会避免不必要的内存写入操作，从而节省一些内存。</p>
</li>
</ul>
<h2 id="字典迭代器和-rehash-的关系">字典迭代器和 rehash 的关系</h2>
<p>在渐进式 rehash 一小节中我们提到，当字典的安全迭代器的数量为0的时候，才会执行 rehash 操作，这是为什么呢？</p>
<p>首先我们可以分析一下字典迭代器的迭代操作，它可以用如下的伪代码来表示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">iter_dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 迭代0号哈希表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iter_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 如果正在进行 rehash 的话，也迭代1号哈希表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">dict</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">is_rehashing</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">iter_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">iter_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 跳过空的哈希表项</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 处理当前哈希表项的单链表上所有的节点</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">node</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">do_some_thing_with</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>假设我们在一个正在进行 rehash 操作的字典上创立了一个安全迭代器，首先执行了<code>dictNext()</code>，获取了<code>ht0</code>中的一个哈希表项<code>he1</code>。接着执行<code>dictAdd()</code>，添加了一个哈希表项。如果<code>dictAdd()</code>函数能够执行 rehash 的话，<code>he1</code>哈希表项可能被从<code>ht0</code>复制到了<code>ht1</code>，从而导致安全迭代器获取了哈希表项<code>he1</code>两次</p>
<p>所以当字典中存在安全迭代器的时候，是不能进行 rehash 操作的。</p>
<p>而对于非安全迭代器，Redis 规定在非安全迭代器的生命周期内只能执行<code>dictNext()</code>操作，不能执行其他操作，从而避免了 rehash 操作。</p>
<p>同时 Redis 在创建非安全迭代器的时候会获取 dict 的指纹，在释放非安全迭代器的时候重新获取指纹，检查两次指纹是否相同。如果不同，证明 dict 被修改过，Redis 就会抛出异常。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-24908c465f52816f8bd5bc366e5a5645">6 - Redis Sort 命令简介</h1>
    
	<blockquote>
<p><code>sort</code>命令是Redis中最强大的命令之一，本文试图通过一些例子来总结Redis Sort的常用方法。</p>
</blockquote>
<h2 id="对列表排序的简单例子">对列表排序的简单例子</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">33</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SORT users
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;4&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;5&#34;</span>
</span></span><span style="display:flex;"><span>5<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;8&#34;</span>
</span></span><span style="display:flex;"><span>6<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;33&#34;</span>
</span></span></code></pre></div><p>在上面的例子中，我们对一系列的数字进行了排序，得到了排序后的结果。</p>
<h2 id="列表排序的更高级的例子">列表排序的更高级的例子</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">33</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SORT users limit <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">4</span> asc alpha
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;33&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;4&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;5&#34;</span>
</span></span></code></pre></div><p>在上面的例子中，我们使用了三个参数，<code>limit</code>, <code>asc</code>和<code>alpha</code>。
<code>limit</code>表示对结果进行分页，其中<code>1</code>表示页数，<code>4</code>表示一页中元素的个数。
<code>asc</code>表示对结果进行正序排序。
<code>alpha</code>表示对结果使用字母序排序，而不是数字序。</p>
<h2 id="基于引用对象进行排序">基于引用对象进行排序</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 首先添加一组用户ID</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">454</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 然后添加一些user_age:id key用来表示用户的年龄</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:13 <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:84 <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:23 <span style="color:#0000cf;font-weight:bold">34</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:454 <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用sort命令基于用户年龄对用户进行排序</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; sort users by user_age:* desc
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;23&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;84&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;13&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;454&#34;</span>
</span></span></code></pre></div><p>在上面的例子中，我们使用一些值<code>user_age:*</code>，来对列表进行排序。
我们通过<code>sort</code>命令强大的<code>by</code>参数来设置排序的规则。<code>by</code>参数除了可以指定基于键值对数据进行排序外，也可以基于哈希对象进行排序，请看下面这个例子:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加一组用户ID</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">454</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加了一组哈希对象来表示用户</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:13 age <span style="color:#0000cf;font-weight:bold">20</span> name user_13
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:84 age <span style="color:#0000cf;font-weight:bold">23</span> name user_84
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:23 age <span style="color:#0000cf;font-weight:bold">34</span> name user_23
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:454 age <span style="color:#0000cf;font-weight:bold">11</span> name user_454
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 基于哈希对象的来对上面的例子进行排序</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; sort users by user:*-&gt;age
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;454&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;13&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;84&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;23&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 基于哈希对象的来对上面的例子进行排序，并获取用户名称</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; sort users by user:*-&gt;age get user:*-&gt;name
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_454&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_13&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_84&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_23&#34;</span>
</span></span></code></pre></div><p>在这个例子中，<code>users</code>是一个列表用来表示用户ID，<code>user:*</code>为哈希对象用来表示用户。
在第一个<code>sort</code>命令中，我们基于用户哈希对象的<code>age</code>字段来进行排序，得到的结果为排序过后的用户ID列表。
如果想要取的返回值不是用户ID的话，也可以通过<code>get</code>参数来指定获取的字段。
在第二个<code>sort</code>命令中，我们还是通过用户哈希对象的<code>age</code>字段来排序，获取的结果为用户哈希对象的<code>name</code>字段组成的数组。</p>
<h2 id="存储查询结果">存储查询结果</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加一组用户ID</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">454</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加一组key用来表示用户年龄</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:13 <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:84 <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:23 <span style="color:#0000cf;font-weight:bold">34</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:454 <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 根据用户年龄对用户ID进行排序，并将排序结果存储在users_sort_result所代表的列表中</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SORT users by user_age:* desc store users_sort_result
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为排序结果设置过期时间</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; expire users_sort_result <span style="color:#0000cf;font-weight:bold">30</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>在上面的例子中，我们根据用户年龄对用户ID进行了排序，同时为排序结果设置了一个过期时间，这样我们就可以将排序结果缓存起来了。
然后每回获取排序结果的时候，我们可以先查缓存，如果缓存不存在的话，则进行排序。
需要注意的是，为了避免多个客户端同时操作排序结果，我们需要使用<code>SETNX</code>命令来为缓存结果设置一个锁，详见<a href="https://redis.io/commands/setnx">SETNX key value</a></p>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-end text-xs-center order-sm-3">
        
        
        
<ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/bwangelme/" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2">
        <span>&copy; 2023 力行近乎仁，好问近乎智，知耻近乎勇 </span>
        <span class="ms-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></span>
        
      </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
      integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ==" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
        integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g=="
        crossorigin="anonymous">
</script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
       integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin="anonymous"
       onload='renderMathInElement(document.body, null);'>
</script>
<script src="/647/js/main.min.6f5832c0d01e88c997eeb57e6b773ea3e1ac128fdf53739b3c750242f2355881.js" integrity="sha256-b1gywNAeiMmX7rV&#43;a3c&#43;o&#43;GsEo/fU3ObPHUCQvI1WIE=" crossorigin="anonymous"></script>
<script src='/647/js/prism.js'></script>
<script src='/647/js/tabpane-persist.js'></script>

  </body>
</html>
