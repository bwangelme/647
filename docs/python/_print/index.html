<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.115.2">
<link rel="canonical" type="text/html" href="https://bwangel.me/647/docs/python/">
<link rel="alternate" type="application/rss&#43;xml" href="https://bwangel.me/647/docs/python/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/647/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/647/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/647/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/647/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/647/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/647/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/647/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/647/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/647/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/647/favicons/android-192x192.png" sizes="192x192">

<title>Python | 647 Universe</title>
<meta name="description" content="宇宙很大，生活更大，也许以后还有缘相见">
<meta property="og:title" content="Python" />
<meta property="og:description" content="宇宙很大，生活更大，也许以后还有缘相见" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://bwangel.me/647/docs/python/" /><meta property="og:site_name" content="647号宇宙" />
<meta itemprop="name" content="Python">
<meta itemprop="description" content="宇宙很大，生活更大，也许以后还有缘相见"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Python"/>
<meta name="twitter:description" content="宇宙很大，生活更大，也许以后还有缘相见"/>




<link rel="preload" href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" as="style">
<link href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/647/css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/647/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">647 Universe</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/647/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/647/docs/python/"></a>.
</p>
</div>



<h1 class="title">Python</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-3174656f7062052451f0c9f528df376b">Python2 使用 Thrift 为什么会出现 EINTR 错误</a></li>


    
  
    
    
	
<li>2: <a href="#pg-8ffc0b133015cfd66db7f485c8157c6b">匹配所有可打印 Ascii 字符的正则</a></li>


    
  
    
    
	
<li>3: <a href="#pg-dd6b8c93984d98fe6f8c5851846c88d9">Python Upgrade Importerror</a></li>


    
  
    
    
	
<li>4: <a href="#pg-958da66e5791d6c739afd62fdccfea9d">Django的override_settings修饰器浅析</a></li>


    
  
    
    
	
<li>5: <a href="#pg-aca9b1506e43349a065aee60cb29920c">Django中import_string的实现</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-3174656f7062052451f0c9f528df376b">1 - Python2 使用 Thrift 为什么会出现 EINTR 错误</h1>
    
	<h2 id="eintr-错误是什么">EINTR 错误是什么</h2>
<p>在 <a href="https://man7.org/linux/man-pages/man7/signal.7.html">man 7 signal</a> 中写到，</p>
<blockquote>
<p>If a signal handler is invoked while a system call or library
function call is blocked, then either:</p>
<p>•  the call is automatically restarted after the signal handler
returns; or</p>
<p>•  the call fails with the error EINTR.</p>
</blockquote>
<p>如果一些阻塞的系统调用或库函数调用被信号中断了，会发生以下任一情况</p>
<ol>
<li>在信号处理函数执行完以后，系统调用或库函数调用继续执行</li>
<li>系统调用或库函数调用失败，返回错误码 EINTR</li>
</ol>
<p>具体会发生哪种情况，取决于具体的系统调用接口和是否通过 <a href="https://man7.org/linux/man-pages/man7/signal.7.html">sigaction</a> 设置了 <code>SA_RESTART</code> 标记。</p>
<p>例如</p>
<ul>
<li><code>read</code>, <code>readv</code>, <code>wait</code>, 没有设置超时的 <code>recv</code> 和 <code>send</code> 等调用会受到 <code>SA_RESTART</code> 标记的控制，继续执行或返回 EINTR 错误</li>
<li>设置了超时的 <code>send</code> 和 <code>recv</code>, <code>epoll_wait</code>, <code>poll</code> 等接口不会受到 <code>SA_RESTART</code>，都是直接返回 EINTR 错误码</li>
</ul>
<h2 id="为什么要有-eintr-错误">为什么要有 EINTR 错误</h2>
<p>从上面的 man 文档中可知，<code>EINTR</code> 其实并不是一个错误，只是程序被信号中断了而已。Unix/Linux 系统要设计成中断系统调用，并返回一个错误码呢?</p>
<p>在 <a href="https://peps.python.org/pep-0475/">PEP 475</a> 中说</p>
<blockquote>
<p>Therefore, when a signal is received by a process during the execution of a system call,
the system call can fail with the EINTR error to give the program an opportunity to handle the signal without the restriction on signal-safe functions.</p>
</blockquote>
<p>系统调用返回 <code>EINTR</code> 的设计，让信号处理函数有机会能在不考虑信号安全的情况下编写。</p>
<p>光看这句话看不太明白，后来我又搜索了一下，看到了 StackOverflow 上的一篇回答。</p>
<ul>
<li><a href="https://unix.stackexchange.com/a/253358/191858">What is the rationale behind EINTR?</a></li>
</ul>
<p>这里面说，信号处理函数因为要考虑可重入性，在函数中，很多系统调用都是不能使用的。这就决定了信号处理函数中不能编写复杂的逻辑。</p>
<p>大部分程序的逻辑是，在 signal handler 里面设置一个 flag, 然后主线程再检查 flag, 做出具体操作。</p>
<p>如果程序在系统调用上卡住了，那么 signal handler 设置了 flag 之后，主线程无法及时执行后续操作，相当于信号没有及时处理。</p>
<p>所以 unix 的设计者才定义了 EINTR 这个错误，让系统调用及时结束，将执行权交换给用户程序，及时处理信号。</p>
<h2 id="复现一个-eintr-错误">复现一个 EINTR 错误</h2>
<p>了解了 EINTR 错误的原理后，我们再来看一下 Python2 调用 Thrift 的时候，经常会出现的一个和 EINTR 有关的错误。</p>
<p>我们可以用以下代码复现一下这个错误</p>
<h3 id="代码准备">代码准备</h3>
<ol>
<li>从 <a href="https://github.com/bwangelme/thrift-eintr">github.com/bwangelme/thrift-eintr</a> 克隆代码</li>
<li>在代码目录中，使用 virtualenv 分别创建 venv2 和 venv3 两个 Python 虚拟环境</li>
</ol>
<pre tabindex="0"><code>~/.pyenv/versions/2.7.18/bin/virtualenv venv2
~/.pyenv/versions/3.11.0/bin/virtualenv venv3
</code></pre><p>服务端的代码比较简单，他就是提供了 <code>get_image</code> 接口，读取图片文件并返回文件内容，这里就不过多赘述了。</p>
<p>客户端的代码中主要做了两件事情。</p>
<ol>
<li>处理 SIGUSR1 信号</li>
<li>调用 get_image 接口获取文件</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">signal_handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">frame</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Receive sig </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">signum</span><span style="color:#000;font-weight:bold">,))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 注册处理信号的 handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">signal</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signal</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">SIGUSR1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">signal_handler</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 打印进程 ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Start client @ </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">getpid</span><span style="color:#000;font-weight:bold">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">transport</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">TSocket</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TSocket</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;localhost&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">9090</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">transport</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">TTransport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TBufferedTransport</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">transport</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">TBinaryProtocol</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TBinaryProtocol</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">transport</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Calculator</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">transport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">open</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 调用 thrift 接口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Start thrift req&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_image</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dur</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;get </span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06"> bytes in </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">dur</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;__main__&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#000">Thrift</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TException</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">tx</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 遇到错误后打印异常和栈信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tx</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">inner</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">traceback</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">print_exc</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="复现错误">复现错误</h3>
<ol>
<li>为了有时间能够发送信号，我们首先调慢 lo 网卡(即 localhost)的发包速度, 这样 <code>get_image</code> 接口就会持续十几秒才结束。</li>
</ol>
<pre tabindex="0"><code># 设置 lo 网卡上发出去的包都有 1000ms 的延迟
ø&gt; sudo tc qdisc add dev lo root netem delay 1000ms

# 使用 list 可以看到我们刚刚创建的规则
ø&gt; sudo tc qdisc list
qdisc netem 8001: dev lo root refcnt 2 limit 1000 delay 1s
...

# 执行完测试函数后，记得删掉这个规则
# ø&gt; sudo tc qdisc del dev lo root
</code></pre><ol start="2">
<li>首先使用 <code>./venv2/bin/python server.py</code> 启动 server,</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; python server.py
</span></span><span style="display:flex;"><span>Starting the server...
</span></span></code></pre></div><p>然后再启动 client</p>
<pre tabindex="0"><code>ø&gt; ./venv2/bin/python client.py

Start client @ 241683
Start thrift req
</code></pre><p>client 启动以后，会打印进程 id <code>241683</code>, <code>Start thrift req</code> 表示开始调用 <code>get_image</code> 接口了。</p>
<p>由于网卡速度很慢，我们 client 会阻塞十几秒。此时我们可以给 client 发送一个 <code>SIGUSR1</code> 信号:</p>
<pre tabindex="0"><code>kill -SIGUSR1 241683
</code></pre><p>client 在收到信号后会处理信号，并抛出一个异常</p>
<pre tabindex="0"><code># 这句表示 SIGUSR1 信号已经处理完了
Receive sig 10

# 打印出来的异常的类型及其值
(TTransportException(&#39;unexpected exception&#39;,), error(4, &#39;Interrupted system call&#39;))

# 抛出异常的栈信息
Traceback (most recent call last):
      File &#34;client.py&#34;, line 50, in &lt;module&gt;
          main()
        File &#34;client.py&#34;, line 43, in main
          res = client.get_image()
        File &#34;gen-py/tutorial/Calculator.py&#34;, line 35, in get_image
          return self.recv_get_image()
        File &#34;gen-py/tutorial/Calculator.py&#34;, line 53, in recv_get_image
          result.read(iprot)
        File &#34;gen-py/tutorial/Calculator.py&#34;, line 178, in read
          self.success = iprot.readBinary()
        File &#34;/home/xuyundong/Github/Python/thrift-eintr/venv2/lib/python2.7/site-packages/thrift/protocol/TBinaryProtocol.py&#34;, line 234, in readBinary
          s = self.trans.readAll(size)
        File &#34;/home/xuyundong/Github/Python/thrift-eintr/venv2/lib/python2.7/site-packages/thrift/transport/TTransport.py&#34;, line 62, in readAll
          chunk = self.read(sz - have)
        File &#34;/home/xuyundong/Github/Python/thrift-eintr/venv2/lib/python2.7/site-packages/thrift/transport/TTransport.py&#34;, line 164, in read
          self.__rbuf = BufferIO(self.__trans.read(max(sz, self.__rbuf_size)))
        File &#34;/home/xuyundong/Github/Python/thrift-eintr/venv2/lib/python2.7/site-packages/thrift/transport/TSocket.py&#34;, line 164, in read
          raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
      TTransportException: unexpected exception
</code></pre><p>从栈信息我们可以知道，抛出异常的位置是 <code>thrift/transport/TSocket.py:164</code>，它的代码如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sz</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">buff</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">handle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">recv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#000">socket</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">errno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ECONNRESET</span> <span style="color:#204a87;font-weight:bold">and</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">platform</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;darwin&#39;</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">platform</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">startswith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;freebsd&#39;</span><span style="color:#000;font-weight:bold">))):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># freebsd and Mach don&#39;t follow POSIX semantic of recv</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># and fail with ECONNRESET if peer performed shutdown.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># See corresponding comment and code in TSocket::read()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># in lib/cpp/src/transport/TSocket.cpp.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># Trigger the check to raise the END_OF_FILE exception below.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">buff</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">errno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ETIMEDOUT</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#000">TTransportException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">TTransportException</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TIMED_OUT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;read timeout&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inner</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># 在这里抛出了异常</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#000">TTransportException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;unexpected exception&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inner</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#000">TTransportException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">TTransportException</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">END_OF_FILE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                      <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;TSocket read 0 bytes&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">buff</span>
</span></span></code></pre></div><p>这段代码逻辑就是，client 已经发送完了请求，正在等待 server 返回响应的时候，收到了一个 <code>socket.error</code>, 它的值是</p>
<pre tabindex="0"><code>error(4, &#39;Interrupted system call&#39;)

# 在 python 标准库的 errno.py 文件中也可以看到 4 表示是 EINTR 错误
EINTR = 4
</code></pre><h3 id="python3-中无法复现">python3 中无法复现</h3>
<p>如果我们使用 Python3 启动 client, 再往该进程发送 SIGUSR1 信号，它就不会抛出异常。</p>
<pre tabindex="0"><code>ø&gt; ./venv3/bin/python client.py
Start client @ 241720
Start thrift req
# 收到了两次信号
Receive sig 10
Receive sig 10
get 2745109 bytes in 16.005424737930298
</code></pre><p>EINTR 是什么错误，为什么 Python2 中抛异常，Python3不会抛异常呢，且听我慢慢讲解。</p>
<h2 id="为什么-python2-和-python3-的表现不同">为什么 Python2 和 Python3 的表现不同</h2>
<h3 id="python-的原因">Python 的原因</h3>
<p>Python 在 <a href="https://peps.python.org/pep-0475/">PEP 475</a> 中实现了，在系统调用遇到 EINTR 的时候自动重试。</p>
<p>而且它只在 signal handler 没有抛出异常的时候重试，这样确保信号能够中断程序的执行，不会阻塞在系统调用中。</p>
<p>以下是中断后能够自动重试的函数列表:</p>
<ul>
<li>open() 和 io.open();</li>
<li><a href="https://docs.python.org/3/library/faulthandler.html#module-faulthandler">faulthandler</a> 模块相关的函数;</li>
<li>os 模块的函数: fchdir(), fchmod(), fchown(), fdatasync(), fstat(), fstatvfs(), fsync(), ftruncate(), mkfifo(), mknod(), open(), posix_fadvise(), posix_fallocate(), pread(), pwrite(), read(), readv(), sendfile(), wait3(), wait4(), wait(), waitid(), waitpid(), write(), writev();</li>
<li>特例: os.close() 和 os.dup2() 会忽略 EINTR 错误，并且不会重试</li>
<li>select 函数: devpoll.poll(), epoll.poll(), kqueue.control(), poll.poll(), select();</li>
<li>socket 类相关的函数: accept(), connect() (except for non-blocking sockets), recv(), recvfrom(), recvmsg(), send(), sendall(), sendmsg(), sendto();</li>
<li>signal.sigtimedwait() 和 signal.sigwaitinfo();</li>
<li>time.sleep().</li>
</ul>
<p>但是 PEP 475 仅在 Python 3.5 及之后的版本中生效，在 Python 2.7 的版本中，是没有这个处理逻辑的。</p>
<h3 id="thrift-的原因">Thrift 的原因</h3>
<p>在 Thrift 的 <a href="https://issues.apache.org/jira/browse/THRIFT-617">Issue-617</a> 中，有人提到了在网络 IO 接口中忽略 EINTR 错误的建议。维护者的回答是，这个问题已经在 Python 3.5 中修了，没有提到 Python 2.7 该怎么办。</p>
<p>PEP 475 只管 Python3, thrift 没有针对 Python2 做特殊处理，这就导致了上述错误只会在 Python 2 出现，Python 3 不会出现。</p>
<h2 id="thrift-在-python2-环境中忽略-eintr">thrift 在 Python2 环境中忽略 EINTR</h2>
<p>目前 Python 和 Thrift 官方都无意去处理这个问题，我们可以修改一下 thrift 代码，手动处理 EINTR 错误。我的处理办法很简单，遇到 EINTR 错误，直接重试即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#a40000">--- a/lib/py/src/transport/TSocket.py
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+++ b/lib/py/src/transport/TSocket.py
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span><span style="color:#800080;font-weight:bold">@@ -149,22 +149,26 @@ class TSocket(TSocketBase):
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>         raise TTransportException(type=TTransportException.NOT_OPEN, message=msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     def read(self, sz):
</span></span><span style="display:flex;"><span><span style="color:#a40000">-        try:
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            buff = self.handle.recv(sz)
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        except socket.error as e:
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            if (e.args[0] == errno.ECONNRESET and
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                    (sys.platform == &#39;darwin&#39; or sys.platform.startswith(&#39;freebsd&#39;))):
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # freebsd and Mach don&#39;t follow POSIX semantic of recv
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # and fail with ECONNRESET if peer performed shutdown.
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # See corresponding comment and code in TSocket::read()
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # in lib/cpp/src/transport/TSocket.cpp.
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                self.close()
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # Trigger the check to raise the END_OF_FILE exception below.
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                buff = &#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            elif e.args[0] == errno.ETIMEDOUT:
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                raise TTransportException(type=TTransportException.TIMED_OUT, message=&#34;read timeout&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            else:
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+        while True:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            try:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                buff = self.handle.recv(sz)
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            except socket.error as e:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                if e.args[0] == errno.EINTR:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    pass
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                elif (e.args[0] == errno.ECONNRESET and
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                        (sys.platform == &#39;darwin&#39; or sys.platform.startswith(&#39;freebsd&#39;))):
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # freebsd and Mach don&#39;t follow POSIX semantic of recv
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # and fail with ECONNRESET if peer performed shutdown.
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # See corresponding comment and code in TSocket::read()
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # in lib/cpp/src/transport/TSocket.cpp.
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    self.close()
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # Trigger the check to raise the END_OF_FILE exception below.
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    buff = &#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                elif e.args[0] == errno.ETIMEDOUT:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    raise TTransportException(type=TTransportException.TIMED_OUT, message=&#34;read timeout&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                else:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>         if len(buff) == 0:
</span></span><span style="display:flex;"><span>             raise TTransportException(type=TTransportException.END_OF_FILE,
</span></span><span style="display:flex;"><span>                                       message=&#39;TSocket read 0 bytes&#39;)
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">@@ -185,7 +189,8 @@ class TSocket(TSocketBase):
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>                 sent += plus
</span></span><span style="display:flex;"><span>                 buff = buff[plus:]
</span></span><span style="display:flex;"><span>             except socket.error as e:
</span></span><span style="display:flex;"><span><span style="color:#a40000">-                raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+                if e.args[0] != errno.EINTR:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>
</span></span><span style="display:flex;"><span>     def flush(self):
</span></span><span style="display:flex;"><span>         pass
</span></span></code></pre></div><h2 id="吐槽">吐槽</h2>
<ul>
<li>PEP 475 是 2014 年的提案，那一年 Python2 还没有停止维护，然后官方在这个 PEP 中直接忽略了 Python2 ，让 Python2 的开发者自己去捕获 EINTR 错误并重试。Python 社区真的不是一个好社区，如果你想开发一个能够维护10年以上的程序，不建议用 Python</li>
<li>Thrift 维护者也没有考虑 Python2 的情况，认为 Python3 已经修了，就万事大吉了，让 Python2 的 client 和 server 多了很多不必要的 TTransportException</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8ffc0b133015cfd66db7f485c8157c6b">2 - 匹配所有可打印 Ascii 字符的正则</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p><code>[ -~]</code> 可以匹配所有的可打印 ascii 字符</p>
<pre tabindex="0"><code>In [1]: import re

In [2]: p = re.compile(&#39;[ -~]&#39;)

In [3]: p.match(&#39;中文&#39;)

In [4]: p.match(&#39;ドウバン&#39;)

In [5]: p.match(&#39;^&amp;#^&amp;@#abcdefdjskla&#39;)
Out[5]: &lt;re.Match object; span=(0, 1), match=&#39;^&#39;&gt;
</code></pre><p>它的原理就是匹配 ASCII 码表中所有从 <code>空格(0x20)</code> 到 <code>-(0x7E)</code> 的字符</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-12-15-191941.png" alt=""></p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd6b8c93984d98fe6f8c5851846c88d9">3 - Python Upgrade Importerror</h1>
    
	<blockquote>
<ul>
<li>记一次因 Python 升级导致的 ImportError</li>
</ul>
</blockquote>
<p>我们有一个 Django 应用通过 uwsgi 跑在阿里云的 ECS 上，所用的系统是 Ubuntu 16.04，uwsgi 是通过 supervisord 来管理的，每个应用都在单独的 virtualenv 中运行，这就是大概的软件运行环境。</p>
<p>因为一些软件没有升级，阿里云一直提示存在安全漏洞，所以我就想把 ECS 上的系统升级一下。升级的过程并没有什么什么问题，毕竟用的阿里云自己维护的源，基本上不会出现什么版本依赖之类的问题。</p>
<h1 id="出错场景">出错场景</h1>
<p>升级完成后重新启动 Django 应用，发现应用启动不起来，uwsgi 报错</p>
<pre tabindex="0"><code>from _ssl import HAS_SNI, HAS_ECDH, HAS_NPN, HAS_ALPN, HAS_TLSv1_3
ImportError: cannot import name &#39;HAS_TLSv1_3&#39;
</code></pre><h1 id="原因分析">原因分析</h1>
<h2 id="从异常入手查找原因">从异常入手查找原因</h2>
<p>抛出的异常意思是在<code>_ssl</code>模块中没有<code>HAS_TLSv1_3</code>的属性，于是我就去Python 文档中查询了一下这个属性，它的解释是这样的：</p>
<pre tabindex="0"><code>ssl.HAS_TLSv1_3
Whether the OpenSSL library has built-in support for the TLS 1.3 protocol.

New in version 3.6.3.
</code></pre><p>看到<code>New in version 3.6.3.</code>的字样，再去查系统的升级记录，我发现刚刚执行的升级中就把宿主机的 Python 从3.6.2升级到了3.6.3，此时我隐隐约约觉得就是因为此次升级导致了 uwsgi 启动时的报错。</p>
<p>但我升级的是宿主机的 Python，它又是如何影响到了 Virtualenv 中的 Python 呢？各位别急，我们接着往下挖。</p>
<h2 id="has_tlsv1_3的定义"><code>HAS_TLSv1_3</code>的定义</h2>
<p>我们接着再去看抛出异常的那行代码，它在 Python 的标准库的<code>ssl.py</code>的<a href="https://github.com/python/cpython/blob/v3.6.3/Lib/ssl.py#L118">118行</a>，具体内容如下：</p>
<pre tabindex="0"><code>from _ssl import HAS_SNI, HAS_ECDH, HAS_NPN, HAS_ALPN, HAS_TLSv1_3
</code></pre><p>我们可以看到，抛出异常就是因为Python解释器从<code>_ssl</code>模块中导入<code>HAS_TLSv1_3</code>时，出现了导入异常。</p>
<p>而<code>_ssl</code>模块是用C语言编写的，它被编译进入了Python解释器中，它的代码位于 Python 源码的 <a href="https://github.com/python/cpython/blob/v3.6.3/Lib/ssl.py">Modules/_ssl.c</a> 文件中。</p>
<p>在它的<a href="https://github.com/python/cpython/blob/v3.6.3/Modules/_ssl.c#L5154-L5206">5154-5206</a>行，我们可以看到它对于<code>_ssl</code>模块的定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">PyModuleDef</span> <span style="color:#000">_sslmodule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PyModuleDef_HEAD_INIT</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;_ssl&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">module_doc</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PySSL_methods</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">PyMODINIT_FUNC</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PyInit__ssl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PyObject</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// _ssl 模块在这里定义，指针m代表了_ssl模块
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PyModule_Create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">_sslmodule</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span></code></pre></div><p>而在它的<a href="https://github.com/python/cpython/blob/v3.6.3/Modules/_ssl.c#L5462-L5468">5642-5468</a>行，我们可以看到<code>_ssl</code>模块中对于<code>HAS_TLSv1_3</code>属性的定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#if defined(TLS1_3_VERSION) &amp;&amp; !defined(OPENSSL_NO_TLS1_3)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Py_True</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Py_False</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Py_INCREF</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 下面这条语句向_ssl模块中添加了布尔值 HAS_TLSv1_3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">PyModule_AddObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;HAS_TLSv1_3&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>上述的代码主要就是判断当前系统是否支持 TLS 1.3版本，并向<code>_ssl</code>模块添加了一个布尔值<code>HAS_TLSv1_3</code>来表明当前系统是否支持 TLS 1.3版本。</p>
<h2 id="错误复现">错误复现</h2>
<p>从上面的分析中我们可以看出，我们可以知道三件事情，</p>
<ol>
<li><code>HAS_TLSv1_3</code>这个布尔值是被编译进 Python 解释器中的，</li>
<li>根据 <a href="https://docs.python.org/3/library/ssl.html#ssl.HAS_TLSv1_3">Python 文档</a> 的说明，<code>HAS_TLSv1_3</code>是在 Python 3.6.3中新添加的。</li>
<li>我们将宿主机的 Python 从3.6.2升级到了3.6.3，但是我们的 Virtualenv 仍然使用着 3.6.2 版本的 Python 解释器。</li>
</ol>
<p>知道了以上三点，我们就可以复现出我们的错误场景，梳理出整个出错的流程：</p>
<ul>
<li>uwsgi 启动，使用的是 Virtualenv 中的 3.6.2版本的 Python 解释器</li>
<li>Python 3.6.2 的解释器在某些第三方库中执行了<code>import ssl</code>的语句</li>
<li>由于 Virtualenv 创建的时候并没有将标准库的<code>ssl.py</code>文件一并复制过来，所以 Python 3.6.2 的解释器去系统目录下寻找<code>ssl.py</code>文件并执行</li>
<li>Python 3.6.2 的解释器找到了系统目录下的<code>ssl.py</code>文件，也就是 Python 3.6.3 的系统库文件。</li>
<li>Python 3.6.2 的解释器执行了 Python 3.6.3的库文件<code>ssl.py</code>中的一条导入语句：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">_ssl</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">HAS_SNI</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HAS_ECDH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HAS_NPN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HAS_ALPN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HAS_TLSv1_3</span>
</span></span></code></pre></div><ul>
<li>Python 3.6.2 的解释器从解释器內建的模块<code>_ssl</code>中导入<code>HAS_TLSv1_3</code></li>
<li>由于 Python 3.6.2 的解释器中并没有定义<code>HAS_TLSv1_3</code>这个布尔值，程序抛出<code>ImportError</code></li>
</ul>
<p>上面这个出错流程也可以用下面这张图来概括:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-02-18-2017-10-14-080329.jpg" alt="Import Error"></p>
<h1 id="错误总结">错误总结</h1>
<p>看到这里，我想 Virtualenv 创建时没有复制系统库文件<code>ssl.py</code>过来，是不是因为我没有指定它的 <a href="https://virtualenv.pypa.io/en/stable/reference/#cmdoption-always-copy">&ndash;always-copy</a> 属性，我特意指定了这个属性又来创建了一遍 Virtualenv，发现它还是没有复制<code>ssl.py</code>文件过来。</p>
<p>关于这个问题，我请教了公司的一位大佬。大佬说这样设计其实复合 Virtualenv 的定位，它只是做 Python 第三方库的隔离，并不做 Python 版本的隔离。</p>
<p>所以如果我们以后需要在同一个系统上安装多个 Python 版本的话，还是需要使用 <a href="https://github.com/pyenv/pyenv">pyenv</a> 这样的工具，而不能指望 Virutalenv 的 <a href="https://virtualenv.pypa.io/en/stable/reference/#cmdoption-p">&ndash;python</a> 选项。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-958da66e5791d6c739afd62fdccfea9d">4 - Django的override_settings修饰器浅析</h1>
    
	<blockquote>
<ol>
<li>Django的Settings模块代码说明</li>
<li>Django的<code>override_settings</code>修饰器分析</li>
</ol>
</blockquote>
<h2 id="前言">前言</h2>
<p>前两天刚刚看了Django settings的实现，今天又发现了测试工具中有个<code>override_settings</code>修饰器，于是就想从它下手来分析一下Django的<code>settings</code>。</p>
<p>本篇文章主要分析的是<code>override_settings</code>作为修饰器的实现，其作为上下文管理器的部分并未详细分析。</p>
<h2 id="django的settings说明">Django的settings说明</h2>
<p>在分析这个修饰器之前，我们先来了解一下Django的<code>settings</code>是如何实现的， Django的<code>settings</code>的代码存放在<code>django/conf/__init__.py</code>中，其中主要有三个类，<code>LazySettings</code>，<code>Settings</code>和<code>UserSettingsHolder</code>。</p>
<h3 id="settings">Settings</h3>
<p><code>Settings</code>类实现了Django配置的载入和存储功能，在它的<code>__init__</code>函数中，首先从<code>django/conf/global_settings.py</code>文件中导入Django默认的配置，然后再从<code>DJANGO_SETTINGS_MODULE</code>环境变量所指定的配置文件中导入我们项目自定义的配置，然后逐项地检查并添加配置。</p>
<p>需要注意的是，<code>Settings</code>会把我们自定义的配置的名称存放到<code>Settings._explicit_settings</code>集合中，<code>Settings.is_overriden</code>函数就是通过检查<code>Settings._explicit_settings</code>集合，来查看某项配置是否被我们自定义的配置给覆盖掉了。</p>
<h3 id="lazysettings">LazySettings</h3>
<p><code>LazySettings</code>是<code>Settings</code>类的一个代理，或者可以认为是对<code>Settings</code>的一层包裹，它的主要功能就是<code>Lazy</code>，或者叫做懒载入。它把<code>Settings</code>类的实例存放在它的私有变量<code>_wrapped</code>中，初始化的时候，它默认将<code>_wrapped</code>设置为空，只有当从<code>LazySettings</code>中取值的时候(会调用<code>LazySettings.__getattr__</code>函数)，它才会调用<code>_setup</code>函数，实例化一个<code>Settings</code>对象，并从中取出对应的配置项。</p>
<p>我们平常在代码中使用的<code>django.conf.settings</code>对象，就是这个类的实例。</p>
<h3 id="usersettingsholder">UserSettingsHolder</h3>
<p><code>UserSettingsHolder</code>类和上面两个类有些不同，它也是用来存储用户的配置项的，只不过它并不会从<code>django/conf/global_settings.py</code>文件中读取Django默认的配置，它只是单纯地将用户传入的配置存储起来，以供读取。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">default_settings</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Requests for configuration variables not in this class are satisfied
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    from the module specified in default_settings (if possible).
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__dict__</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;_deleted&#39;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">set</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">default_settings</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">default_settings</span>
</span></span></code></pre></div><p>上面就是<code>UserSettingsHolder</code>构造函数，从中我们可以看到，它接收一个<code>default_settings</code>参数，它主要就是从这个参数中获取并存储用户要设置的配置，并不存储Django默认的配置。</p>
<h2 id="override_settings修饰器的分析">override_settings修饰器的分析</h2>
<p>了解完Django的<code>settings</code>的实现以后，我们再来看一下<code>override_settings</code>修饰器。</p>
<p>我们在使用<code>override_settings</code>作为修饰器的时候，通常的形式是这样的:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@override_settings</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_some_feature</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><p>上面的代码中修饰器的部分，我们可以使用下面这种方式来理解它:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#000">test_some_feature</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">override_settings</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">test_some_feature</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>从上面的形式可以看出，修饰器语法真正调用的是<code>override_settings</code>类的<code>__call__</code>方法，所以我们需要去关注一下<code>override_settings</code>的<code>__call__</code>方法。但是这个方法在<code>override_settings</code>类中并没有实现，它是在它的父类<code>TestContextDecorator</code>中实现的。</p>
<h3 id="testcontextdecorator">TestContextDecorator</h3>
<h4 id="__call__方法"><code>__call__</code>方法</h4>
<p><code>TestContextDecorator</code>类的<code>__call__</code>方法如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__call__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">isinstance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decorate_class</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#000">callable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decorate_callable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">TypeError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Cannot decorate object of type </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#39;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>从代码中我们可以看出，这个函数的功能主要就是对被修饰的对象进行了一下鉴别，如果修饰的是类，则调用<code>decorate_class</code>函数，如果修饰的是其他的可调用对象，则调用<code>decorate_callable</code>函数。</p>
<h4 id="decorate_class">decorate_class</h4>
<p>接着我们来看一下<code>decorate_class</code>函数，它的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">decorate_class</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">cls</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">issubclass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">cls</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TestCase</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">decorated_setUp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">cls</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">setUp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">decorated_tearDown</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">cls</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">tearDown</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">setUp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">enable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">attr_name</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">-&gt;</span>     <span style="color:#204a87">setattr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">attr_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">decorated_setUp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">tearDown</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">decorated_tearDown</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">disable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">cls</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">setUp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">setUp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">cls</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">tearDown</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tearDown</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">cls</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">TypeError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Can only decorate subclasses of unittest.TestCase&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>从上面的代码可以看出，<code>decorate_class</code>函数的针对<code>TestCase</code>类的<code>setUp</code>和<code>tearDown</code>函数添加了一些额外的代码，即我用<code>-&gt;</code>符号标记的部分。</p>
<p>这些代码的主要功能就是在<code>TestCase</code>类初始化的时候调用<code>TestContextDecorator.enable</code>函数，再以<code>self.attr_name</code>的值作为名称，把<code>enable</code>函数的返回值插入到<code>TestCase</code>类的实例中。同时在<code>TestCase</code>类销毁的时候调用<code>TestContextDecorator.disable</code>函数。</p>
<p>我们接着再去查看<code>TestContextDecorator.enable</code>和<code>TestContextDecorator.disable</code>函数，我们发现它们是在<code>override_settings</code>子类中实现的，那我们对于<code>decorate_class</code>的分析就到这里，<code>enable</code>和<code>disable</code>函数在后面分析到<code>override_settings</code>子类的时候会继续分析。</p>
<h4 id="decorate_callable">decorate_callable</h4>
<blockquote>
<p><strong>注意</strong>:
这个函数的代码涉及到了Python的上下文管理器(<code>with</code>语句)的部分知识，如果你可以自己动手写一个上下文管理器的话，继续阅读即可。
如果你对于上下文管理器还有些疑问的话，请参考我的另一篇文章: <a href="/2016/04/25/python%E7%9A%84with%E8%AF%AD%E5%8F%A5/">PEP 343: Python的with语句</a></p>
</blockquote>
<p>分析完了<code>decorate_class</code>函数，我们接着回到<code>TestContextDecorator.__call__</code>方法，接着分析被修饰对象是可调用对象的那一种情况，也就是<code>TestContextDecorator.decorate_callable</code>函数。<code>decorate_callable</code>函数的代码如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">decorate_callable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">func</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@wraps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">func</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">inner</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#3465a4">self</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">kwarg_name</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">kwarg_name</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">context</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">inner</span>
</span></span></code></pre></div><p>可以看到，<code>decorate_callable</code>函数其实就是一个修饰器，它的主要功能就是将<code>TestContextDecorator</code>的实例作为一个上下文管理器进行了调用，需要注意的是，<code>return</code>语句是被包裹在<code>with</code>语句内的，也就是说，被修饰的函数执行完了以后，才会接着执行上下文管理器的<code>__exit__</code>函数。同时，它还会使用<code>self.kwarg_name</code>的值作为参数名字，将上下文管理器的返回值(也就是<code>__enter__</code>函数的返回值)传入被修饰的函数中。</p>
<p>既然<code>decorate_callable</code>将<code>TestContextDecorator</code>当做一个上下文管理器来使用，我们就需要关注一下它的<code>__enter__</code>和<code>__exit__</code>函数，这两个函数的代码如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__enter__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">enable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__exit__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exc_type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exc_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">traceback</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">disable</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>可以看到，这两个函数的功能，基本上也是调用<code>enable</code>和<code>disable</code>函数。</p>
<h3 id="override_settings">override_settings</h3>
<p>分析完了<code>override_settings</code>的父类，我们接着来分析这个类本身。从上面的分析中我们可以看到，<code>override_settings</code>对于被修饰的类或者函数基本上就是做两件事，类或者函数初始化之前调用<code>enable</code>函数，并将<code>enable</code>函数的返回值传递到被修饰的类或者函数中。然后再在被修饰的类或者函数退出的时候调用<code>disable</code>函数。所以，我们将关注点集中到<code>override_settings</code>类的<code>enable</code>和<code>disable</code>函数上就好了。</p>
<p>首先来说<code>override_settings.enable</code>函数，它的代码如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">enable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Keep this code at the beginning to leave the settings unchanged</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># in case it raises an exception because INSTALLED_APPS is invalid.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 注意self.options其实就是`override_settings`类的构造函数中传入的关键字参数kwargs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#4e9a06">&#39;INSTALLED_APPS&#39;</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">apps</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set_installed_apps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;INSTALLED_APPS&#39;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">apps</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">unset_installed_apps</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">raise</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 这个settings._wrapped就是真实保存的设置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># UserSettingsHolder就是</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">override</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">UserSettingsHolder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">new_value</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">setattr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">override</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">new_value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">wrapped</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">new_value</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setting_changed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sender</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__class__</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#000">setting</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">new_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">enter</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>可以看到<code>enable</code>函数的功能就是在原有的<code>settings</code>配置上，用我们在<code>options</code>中传入的配置覆盖掉原来的配置，并针对修改的配置项发出信号。同时将原来的配置保存到<code>self.wrapped</code>变量中。</p>
<p>接着我们再来看<code>override_settings.disable</code>函数，它的代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">disable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#4e9a06">&#39;INSTALLED_APPS&#39;</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">apps</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">unset_installed_apps</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">wrapped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">del</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">wrapped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">new_value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">getattr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">settings</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setting_changed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sender</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__class__</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#000">setting</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">new_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">enter</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>这个函数的功能也很简单，将<code>self.wrapped</code>中保存的配置还原，并针对更改的配置发出信号。</p>
<h2 id="总结">总结</h2>
<p>OK，至此，对于<code>override_settings</code>的分析就结束了，它的功能也比较简单，就是在一个作用域中修改配置，并在这个作用域结束的时候将配置还原，如果它修饰的作用域是一个函数的话，由于函数不像类有构造和析构函数，它就使用Python的上下文管理器来实现类的构造和析构函数的功能。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aca9b1506e43349a065aee60cb29920c">5 - Django中import_string的实现</h1>
    
	<blockquote>
<p><strong>摘要</strong>:</p>
<ol>
<li>importlib.import_module 函数的功能</li>
<li>import_string 函数的实现</li>
</ol>
</blockquote>
<h2 id="前言">前言</h2>
<p>今天开始来读 Django 的代码，首先想在 Django 内部设置一个logger用来打印调试日志，结果发现在Django内部，DEBUG日志显示不出来，然后我就想这肯定是Django配置日志的时候，根据logger的名字，来确定了一定的日志级别。</p>
<p>于是我就想看看Django的日志是如何配置的，顺着<code>manage.py</code>中的<code>execute_from_command_line</code>一路往下找，就找到了<code>django.utils.log.configure_logging</code>函数，在这个函数中，第一个就遇到了<code>import_string</code>函数，虽然一眼就能看出，这个函数的功能就是通过字符串来导入相应的函数的，但还是忍不住想要看一下它的实现，千里之行，始于足下，阅读Django源码的过程，就从这个11行的函数开始吧。</p>
<h2 id="python的import_module函数">Python的<code>import_module</code>函数</h2>
<p>函数声明: <code>importlib.import_module(name, package=None)</code></p>
<ol>
<li>从<a href="https://docs.python.org/3/library/importlib.html#importlib.import_module">文档</a>中可以看出，这个函数的主要功能就是导入指定的包或者模块,它并不能导入模块中的类或者函数。</li>
<li>这个函数还支持相对导入，如果要使用相对导入的话，需要设置第二个参数<code>package</code>来确认执行相对导入时的当前路径。</li>
<li>如果你想要在运行时动态导入的话，比如新创建一个Python文件再来导入，需要调用<code>importlib.invalidate_caches</code>函数，来确保让导入系统能够发现新的模块。</li>
</ol>
<h2 id="django的import_string函数">Django的<code>import_string</code>函数</h2>
<p><code>import_string</code>函数的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">import_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dotted_path</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">module_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">class_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dotted_path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rsplit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">ValueError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">ImportError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06"> doesn&#39;t look like a module path&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">dotted_path</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">module</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">import_module</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">module_path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">getattr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">module</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">class_name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">AttributeError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">ImportError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Module &#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34; does not define a &#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34; attribute/class&#39;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">module_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">class_name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">err</span>
</span></span></code></pre></div><p>从代码中我们可以看出，这个函数其实很简单，就是首先将要导入的路径名分割成模块名和类名，然后再来从模块中获得到类这个属性，然后就完成了。照着这个思路来看，其实我们导入一个函数也是可以的。</p>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-end text-xs-center order-sm-3">
        
        
        
<ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/bwangelme/" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2">
        <span>&copy; 2023 力行近乎仁，好问近乎智，知耻近乎勇 </span>
        <span class="ms-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></span>
        
      </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
      integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ==" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
        integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g=="
        crossorigin="anonymous">
</script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
       integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin="anonymous"
       onload='renderMathInElement(document.body, null);'>
</script>
<script src="/647/js/main.min.4f6bdd3cd8cde411a9b8cc8c9f435ab27b7a07d49198bf6bc750cdcd26e6e429.js" integrity="sha256-T2vdPNjN5BGpuMyMn0Nasnt6B9SRmL9rx1DNzSbm5Ck=" crossorigin="anonymous"></script>
<script src='/647/js/prism.js'></script>
<script src='/647/js/tabpane-persist.js'></script>

  </body>
</html>
